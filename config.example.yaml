# SesameFS Configuration
# Copy this file to config.yaml and customize for your environment

server:
  port: ":8080"
  read_timeout: 30s
  write_timeout: 300s      # Long timeout for large file uploads
  max_upload_mb: 10240     # 10 GB max upload size

database:
  hosts:
    - localhost:9042
  keyspace: sesamefs
  consistency: LOCAL_QUORUM
  local_dc: datacenter1
  # username: cassandra
  # password: cassandra

storage:
  default_class: hot-s3-usa

  # Storage classes: {tier}-{type}-{region}
  # Each class is a named storage backend with location info
  classes:
    # Hot storage (immediate access) - Multi-region
    hot-s3-usa:
      type: s3
      tier: hot
      endpoint: ""                    # Leave empty for AWS
      bucket: sesamefs-usa
      region: us-east-1
      failover_class: hot-s3-eu       # Failover if this backend is down

    hot-s3-eu:
      type: s3
      tier: hot
      endpoint: ""
      bucket: sesamefs-eu
      region: eu-west-1
      failover_class: hot-s3-usa

    hot-s3-china:
      type: s3
      tier: hot
      endpoint: ""
      bucket: sesamefs-china
      region: cn-north-1

    # Cold storage (delayed access)
    cold-glacier-usa:
      type: glacier
      tier: cold
      bucket: sesamefs-archive-usa
      region: us-east-1

    # Local development (MinIO)
    hot-minio-local:
      type: s3
      tier: hot
      endpoint: "http://localhost:9000"
      bucket: sesamefs-blocks
      region: us-east-1
      access_key: minioadmin
      secret_key: minioadmin
      use_path_style: true            # Required for MinIO

  # Map API hostnames to regions
  endpoint_regions:
    "us.sesamefs.com": "usa"
    "eu.sesamefs.com": "eu"
    "cn.sesamefs.com": "china"
    "*.sesamefs.com": "usa"           # Wildcard default
    "localhost": "local"
    "*": "usa"                        # Global default

  # Map regions to storage classes
  region_classes:
    usa:
      hot: hot-s3-usa
      cold: cold-glacier-usa
    eu:
      hot: hot-s3-eu
      cold: cold-glacier-usa          # Uses USA cold storage
    china:
      hot: hot-s3-china
      cold: ""                        # No cold storage in China yet
    local:
      hot: hot-minio-local
      cold: ""

  # Legacy backends (deprecated, use classes instead)
  # backends:
  #   hot:
  #     type: s3
  #     bucket: sesamefs-blocks-hot

auth:
  dev_mode: true                      # Set to false in production
  dev_tokens:
    - token: "dev-token-123"
      user_id: "00000000-0000-0000-0000-000000000001"
      org_id: "00000000-0000-0000-0000-000000000001"
  oidc:
    issuer: https://accounts.sesamedisk.com
    client_id: ""                     # Set via OIDC_CLIENT_ID env var
    client_secret: ""                 # Set via OIDC_CLIENT_SECRET env var
    scopes:
      - openid
      - profile
      - email

chunking:
  algorithm: fastcdc
  hash_algorithm: sha256

  # Adaptive chunk sizing (adjusts to client network speed)
  # This applies to server-side chunking (web/API uploads)
  # Seafile desktop/mobile clients control their own chunking (256KB-4MB, SHA-1)
  adaptive:
    enabled: true
    absolute_min: 2097152             # 2 MB floor (slow/unstable connections)
    absolute_max: 268435456           # 256 MB ceiling (datacenter speeds)
    initial_size: 16777216            # 16 MB starting point
    target_seconds: 8                 # Target ~8 seconds per chunk upload

  # Speed probe (measures connection before upload)
  probe:
    size: 1048576                     # 1 MB probe size
    timeout: 30s                      # Probe timeout

  # Timeout and retry settings
  retry:
    chunk_timeout: 60s                # Abort chunk after 60 seconds
    max_retries: 5                    # Max retry attempts
    reduce_on_timeout: 0.5            # Reduce to 50% size on timeout
    reduce_on_failure: 0.5            # Reduce to 50% size on failure
    backoff_base: 1s                  # Base backoff duration
    backoff_max_jitter: 500ms         # Max jitter to add

versioning:
  default_ttl_days: 90                # 0 = keep forever
  min_ttl_days: 7
  gc_interval: 24h

# OnlyOffice Document Server integration
onlyoffice:
  enabled: true
  api_js_url: "https://office.sesamedisk.com/web-apps/apps/api/documents/api.js"
  jwt_secret: ""                       # Set via ONLYOFFICE_JWT_SECRET env var
  verify_certificate: false
  force_save: true
  # server_url: Public URL for OnlyOffice to fetch documents (required for remote OnlyOffice servers)
  # If not set, uses SERVER_URL env var or defaults to localhost
  # server_url: "https://files.sesamedisk.com"
  view_extensions:
    - doc
    - docx
    - ppt
    - pptx
    - xls
    - xlsx
    - odt
    - fodt
    - odp
    - fodp
    - ods
    - fods
    - pdf
  edit_extensions:
    - docx
    - pptx
    - xlsx

# lifecycle:
#   enabled: true
#   check_interval: 1h
#   rules:
#     - age_days: 30
#       from_class: hot
#       to_class: warm
#     - age_days: 90
#       from_class: warm
#       to_class: cold
#     - age_days: 365
#       from_class: cold
#       to_class: frozen
