services:
  sesamefs:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      - PORT=8080
      - CASSANDRA_HOSTS=cassandra:9042
      - CASSANDRA_KEYSPACE=sesamefs
      - CASSANDRA_LOCAL_DC=datacenter1
      - AUTH_DEV_MODE=true
      - AWS_REGION=us-east-1
      - S3_ENDPOINT=http://minio:9000
      - S3_BUCKET=sesamefs-blocks
      - AWS_ACCESS_KEY_ID=minioadmin
      - AWS_SECRET_ACCESS_KEY=minioadmin
    depends_on:
      cassandra:
        condition: service_healthy
      minio:
        condition: service_started
    volumes:
      - ./config.yaml:/app/config.yaml:ro
    restart: unless-stopped

  cassandra:
    image: cassandra:5.0
    ports:
      - "9042:9042"
    environment:
      - CASSANDRA_CLUSTER_NAME=sesamefs
      - CASSANDRA_DC=datacenter1
      - CASSANDRA_ENDPOINT_SNITCH=GossipingPropertyFileSnitch
      - MAX_HEAP_SIZE=512M
      - HEAP_NEWSIZE=100M
    volumes:
      - cassandra_data:/var/lib/cassandra
    healthcheck:
      test: ["CMD", "cqlsh", "-e", "describe keyspaces"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 60s
    restart: unless-stopped

  # MinIO for local S3-compatible storage (development)
  minio:
    image: minio/minio:latest
    ports:
      - "9000:9000"      # S3 API
      - "9001:9001"      # Console
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # Create buckets for multi-region simulation
  minio-init:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 minioadmin minioadmin;
      echo 'Creating buckets for multi-region simulation...';
      mc mb myminio/sesamefs-blocks --ignore-existing;
      mc mb myminio/sesamefs-usa --ignore-existing;
      mc mb myminio/sesamefs-eu --ignore-existing;
      mc mb myminio/sesamefs-china --ignore-existing;
      mc mb myminio/sesamefs-archive --ignore-existing;
      mc anonymous set download myminio/sesamefs-blocks;
      mc anonymous set download myminio/sesamefs-usa;
      mc anonymous set download myminio/sesamefs-eu;
      mc anonymous set download myminio/sesamefs-china;
      echo 'Buckets created:';
      mc ls myminio;
      exit 0;
      "

  # SesameFS Web UI (Seafile-compatible frontend)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - SESAMEFS_API_URL=http://localhost:8080
    ports:
      - "3000:80"
    environment:
      - SESAMEFS_API_URL=http://localhost:8080
    depends_on:
      - sesamefs
    restart: unless-stopped

volumes:
  cassandra_data:
  minio_data:
