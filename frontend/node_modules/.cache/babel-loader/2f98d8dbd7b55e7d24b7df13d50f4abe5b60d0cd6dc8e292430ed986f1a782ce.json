{"ast":null,"code":"import _slicedToArray from \"/Users/abel/Documents/Code-Experiments/cool-storage-api/frontend/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";\nimport isHotkey from 'is-hotkey';\nimport { Editor, Node, Range, Transforms } from '@seafile/slate';\nimport { PARAGRAPH, INSERT_POSITION, CODE_BLOCK, CALL_OUT } from '../../constants';\nimport { getSelectedNodeEntryByType, isSelectionAtBlockStart } from '../../core';\nimport { deleteCalloutIcon, getCalloutEntry, isCalloutContentEmpty, unwrapCallout } from './helper';\nimport { insertElement } from '../../toolbar/side-toolbar/helpers';\nimport EventBus from '../../../utils/event-bus';\nimport { INTERNAL_EVENT } from '../../../constants';\nimport { CALLOUT_ALLOWED_INSIDE_TYPES } from './constant';\n\n/**\n * @param {Editor} editor\n * @returns\n */\nvar withCallout = function withCallout(editor) {\n  var insertFragment = editor.insertFragment,\n    deleteBackward = editor.deleteBackward,\n    onHotKeyDown = editor.onHotKeyDown,\n    insertData = editor.insertData,\n    onCopy = editor.onCopy;\n  var newEditor = editor;\n  newEditor.deleteBackward = function (unit) {\n    var calloutEntry = getCalloutEntry(editor);\n    if (calloutEntry) {\n      var node = calloutEntry[0];\n      if (isSelectionAtBlockStart(editor) && !!node.callout_icon) {\n        deleteCalloutIcon(editor);\n        return;\n      }\n      if (isSelectionAtBlockStart(editor) && isCalloutContentEmpty(calloutEntry)) {\n        unwrapCallout(editor);\n        return;\n      }\n    }\n    return deleteBackward(unit);\n  };\n  newEditor.insertData = function (data) {\n    if (getCalloutEntry(newEditor)) {\n      if (data.types.includes('text/code-block')) {\n        var eventBus = EventBus.getInstance();\n        eventBus.dispatch(INTERNAL_EVENT.DISPLAY_CALLOUT_UNSUPPORT_ALERT, CODE_BLOCK);\n        return;\n      }\n    }\n    return insertData(data);\n  };\n  newEditor.insertFragment = function (data) {\n    if (getCalloutEntry(editor)) {\n      var _data$find;\n      // Prvent insert new line when insert fragment\n      if (Range.isCollapsed(editor.selection)) {\n        var paragraphEntry = getSelectedNodeEntryByType(newEditor, PARAGRAPH);\n        if (paragraphEntry) {\n          var parentNodeEntry = Editor.parent(editor, paragraphEntry[1]);\n          if (parentNodeEntry && parentNodeEntry[0].type === CALL_OUT) {\n            if (!Node.string(paragraphEntry[0]).length) {\n              insertFragment(data);\n              return Transforms.removeNodes(newEditor, {\n                at: paragraphEntry[1]\n              });\n            }\n          }\n        }\n      }\n      var eventBus = EventBus.getInstance();\n      var unsupportType = (_data$find = data.find(function (node) {\n        return !CALLOUT_ALLOWED_INSIDE_TYPES.includes(node.type);\n      })) === null || _data$find === void 0 ? void 0 : _data$find.type;\n      if (unsupportType) {\n        eventBus.dispatch(INTERNAL_EVENT.DISPLAY_CALLOUT_UNSUPPORT_ALERT, unsupportType);\n        return;\n      }\n    }\n    return insertFragment(data);\n  };\n  newEditor.onHotKeyDown = function (event) {\n    var calloutEntry = getCalloutEntry(editor);\n    if (calloutEntry) {\n      var _calloutEntry = _slicedToArray(calloutEntry, 2),\n        calloutPath = _calloutEntry[1];\n      // Close color picker\n      var eventBus = EventBus.getInstance();\n      eventBus.dispatch(INTERNAL_EVENT.CLOSE_CALLOUT_COLOR_PICKER);\n      if (isHotkey('mod+enter', event)) {\n        insertElement(newEditor, PARAGRAPH, INSERT_POSITION.AFTER);\n        return true;\n      }\n      if (isHotkey('mod+a', event)) {\n        event.preventDefault();\n        try {\n          var startPoint = Editor.start(newEditor, calloutPath);\n          var endPoint = Editor.end(newEditor, calloutPath);\n          var selectRange = Editor.range(newEditor, startPoint, endPoint);\n          Transforms.select(newEditor, selectRange);\n          return true;\n        } catch (error) {\n          return true;\n        }\n      }\n    }\n    return onHotKeyDown && onHotKeyDown(event);\n  };\n  newEditor.onCopy = function (event) {\n    if (getCalloutEntry(editor)) {\n      event.stopPropagation();\n    }\n  };\n  return newEditor;\n};\nexport default withCallout;","map":{"version":3,"names":["isHotkey","Editor","Node","Range","Transforms","PARAGRAPH","INSERT_POSITION","CODE_BLOCK","CALL_OUT","getSelectedNodeEntryByType","isSelectionAtBlockStart","deleteCalloutIcon","getCalloutEntry","isCalloutContentEmpty","unwrapCallout","insertElement","EventBus","INTERNAL_EVENT","CALLOUT_ALLOWED_INSIDE_TYPES","withCallout","editor","insertFragment","deleteBackward","onHotKeyDown","insertData","onCopy","newEditor","unit","calloutEntry","node","callout_icon","data","types","includes","eventBus","getInstance","dispatch","DISPLAY_CALLOUT_UNSUPPORT_ALERT","_data$find","isCollapsed","selection","paragraphEntry","parentNodeEntry","parent","type","string","length","removeNodes","at","unsupportType","find","event","_calloutEntry","_slicedToArray","calloutPath","CLOSE_CALLOUT_COLOR_PICKER","AFTER","preventDefault","startPoint","start","endPoint","end","selectRange","range","select","error","stopPropagation"],"sources":["/Users/abel/Documents/Code-Experiments/cool-storage-api/frontend/node_modules/@seafile/sdoc-editor/dist/basic-sdk/extension/plugins/callout/plugin.js"],"sourcesContent":["import isHotkey from 'is-hotkey';\nimport { Editor, Node, Range, Transforms } from '@seafile/slate';\nimport { PARAGRAPH, INSERT_POSITION, CODE_BLOCK, CALL_OUT } from '../../constants';\nimport { getSelectedNodeEntryByType, isSelectionAtBlockStart } from '../../core';\nimport { deleteCalloutIcon, getCalloutEntry, isCalloutContentEmpty, unwrapCallout } from './helper';\nimport { insertElement } from '../../toolbar/side-toolbar/helpers';\nimport EventBus from '../../../utils/event-bus';\nimport { INTERNAL_EVENT } from '../../../constants';\nimport { CALLOUT_ALLOWED_INSIDE_TYPES } from './constant';\n\n/**\n * @param {Editor} editor\n * @returns\n */\nconst withCallout = editor => {\n  const {\n    insertFragment,\n    deleteBackward,\n    onHotKeyDown,\n    insertData,\n    onCopy\n  } = editor;\n  const newEditor = editor;\n  newEditor.deleteBackward = unit => {\n    const calloutEntry = getCalloutEntry(editor);\n    if (calloutEntry) {\n      const node = calloutEntry[0];\n      if (isSelectionAtBlockStart(editor) && !!node.callout_icon) {\n        deleteCalloutIcon(editor);\n        return;\n      }\n      if (isSelectionAtBlockStart(editor) && isCalloutContentEmpty(calloutEntry)) {\n        unwrapCallout(editor);\n        return;\n      }\n    }\n    return deleteBackward(unit);\n  };\n  newEditor.insertData = data => {\n    if (getCalloutEntry(newEditor)) {\n      if (data.types.includes('text/code-block')) {\n        const eventBus = EventBus.getInstance();\n        eventBus.dispatch(INTERNAL_EVENT.DISPLAY_CALLOUT_UNSUPPORT_ALERT, CODE_BLOCK);\n        return;\n      }\n    }\n    return insertData(data);\n  };\n  newEditor.insertFragment = data => {\n    if (getCalloutEntry(editor)) {\n      var _data$find;\n      // Prvent insert new line when insert fragment\n      if (Range.isCollapsed(editor.selection)) {\n        const paragraphEntry = getSelectedNodeEntryByType(newEditor, PARAGRAPH);\n        if (paragraphEntry) {\n          const parentNodeEntry = Editor.parent(editor, paragraphEntry[1]);\n          if (parentNodeEntry && parentNodeEntry[0].type === CALL_OUT) {\n            if (!Node.string(paragraphEntry[0]).length) {\n              insertFragment(data);\n              return Transforms.removeNodes(newEditor, {\n                at: paragraphEntry[1]\n              });\n            }\n          }\n        }\n      }\n      const eventBus = EventBus.getInstance();\n      const unsupportType = (_data$find = data.find(node => !CALLOUT_ALLOWED_INSIDE_TYPES.includes(node.type))) === null || _data$find === void 0 ? void 0 : _data$find.type;\n      if (unsupportType) {\n        eventBus.dispatch(INTERNAL_EVENT.DISPLAY_CALLOUT_UNSUPPORT_ALERT, unsupportType);\n        return;\n      }\n    }\n    return insertFragment(data);\n  };\n  newEditor.onHotKeyDown = event => {\n    const calloutEntry = getCalloutEntry(editor);\n    if (calloutEntry) {\n      const [, calloutPath] = calloutEntry;\n      // Close color picker\n      const eventBus = EventBus.getInstance();\n      eventBus.dispatch(INTERNAL_EVENT.CLOSE_CALLOUT_COLOR_PICKER);\n      if (isHotkey('mod+enter', event)) {\n        insertElement(newEditor, PARAGRAPH, INSERT_POSITION.AFTER);\n        return true;\n      }\n      if (isHotkey('mod+a', event)) {\n        event.preventDefault();\n        try {\n          const startPoint = Editor.start(newEditor, calloutPath);\n          const endPoint = Editor.end(newEditor, calloutPath);\n          const selectRange = Editor.range(newEditor, startPoint, endPoint);\n          Transforms.select(newEditor, selectRange);\n          return true;\n        } catch (error) {\n          return true;\n        }\n      }\n    }\n    return onHotKeyDown && onHotKeyDown(event);\n  };\n  newEditor.onCopy = event => {\n    if (getCalloutEntry(editor)) {\n      event.stopPropagation();\n    }\n  };\n  return newEditor;\n};\nexport default withCallout;"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}