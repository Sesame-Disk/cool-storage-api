{"ast":null,"code":"import _slicedToArray from \"/Users/abel/Documents/Code-Experiments/cool-storage-api/frontend/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";\nimport _objectSpread from \"@babel/runtime/helpers/esm/objectSpread2\";\nimport { Node, Range, Transforms, Element, Editor } from '@seafile/slate';\nimport { LIST_ITEM, PARAGRAPH, INSERT_POSITION } from '../../../constants';\nimport { findNode, getNodeEntries, getNodeType, getSelectedNodeEntryByType, isRangeAcrossBlocks } from '../../../core';\nimport { getListItemEntry, getListTypes } from '../queries';\nimport { unwrapList } from './unwrap-list';\nimport { generateEmptyList, generateEmptyListContent, generateEmptyListItem } from '../model';\nvar wrapLineList = function wrapLineList(editor, type) {\n  var list = generateEmptyList(type);\n  Transforms.wrapNodes(editor, list);\n  var nodeEntry = getSelectedNodeEntryByType(editor, PARAGRAPH);\n  if (!nodeEntry) return;\n\n  // select is paragraph\n  // 1 handle paragraph\n\n  // 2 wrap list_item\n  var _nodeEntry = _slicedToArray(nodeEntry, 2),\n    path = _nodeEntry[1];\n  var listItem = generateEmptyListItem();\n  Transforms.wrapNodes(editor, listItem, {\n    at: path\n  });\n  return;\n};\nvar wrapRangeList = function wrapRangeList(editor, type) {\n  // 选中的是一个区间\n  Editor.withoutNormalizing(editor, function () {\n    // 1. 获取公共祖先\n    var _Range$edges = Range.edges(editor.selection),\n      _Range$edges2 = _slicedToArray(_Range$edges, 2),\n      startPoint = _Range$edges2[0],\n      endPoint = _Range$edges2[1];\n    var commonAncestor = Node.common(editor, startPoint.path, endPoint.path);\n    var listTypes = getListTypes();\n\n    // 2. 公共祖先如果是 ordered_list | unordered_list\n    if (listTypes.includes(commonAncestor[0].type) || commonAncestor[0].type === LIST_ITEM) {\n      if (commonAncestor[0].type !== type) {\n        var start = Range.start(editor.selection);\n        var end = Range.end(editor.selection);\n        var options = {\n          at: start,\n          match: {\n            type: listTypes\n          },\n          mode: 'lowest'\n        };\n        var startList = findNode(editor, options);\n        var endList = findNode(editor, _objectSpread(_objectSpread({}, options), {\n          at: end\n        }));\n        var rangeLength = Math.min(startList[1].length, endList[1].length);\n        Transforms.setNodes(editor, {\n          type: type\n        }, {\n          at: editor.selection,\n          match: function match(n, path) {\n            return Element.isElement(n) && listTypes.includes(n.type) && path.length >= rangeLength;\n          },\n          mode: 'all'\n        });\n      } else {\n        unwrapList(editor);\n      }\n      return;\n    }\n\n    // 获取选中的所有节点的子元素\n    var rootPathLength = commonAncestor[1].length;\n    var _nodes = getNodeEntries(editor, {\n      mode: 'all'\n    });\n    var nodes = Array.from(_nodes).filter(function (_ref) {\n      var _ref2 = _slicedToArray(_ref, 2),\n        path = _ref2[1];\n      return path.length === rootPathLength + 1;\n    });\n    nodes.forEach(function (n) {\n      if (listTypes.includes(n[0].type)) {\n        Transforms.setNodes(editor, {\n          type: type\n        }, {\n          at: n[1],\n          match: function match(_n) {\n            return Element.isElement(_n) && listTypes.includes(_n.type);\n          },\n          mode: 'all'\n        });\n      } else {\n        // select content is paragraph\n        // 1 handle content\n\n        // 2. wrap list_item\n        var listItem = generateEmptyListItem();\n        Transforms.wrapNodes(editor, listItem, {\n          at: n[1]\n        });\n\n        // 3. wrap list\n        var list = generateEmptyList(type);\n        Transforms.wrapNodes(editor, list, {\n          at: n[1]\n        });\n      }\n    });\n  });\n};\nvar toggleList = function toggleList(editor, type, insertPosition) {\n  if (insertPosition === INSERT_POSITION.AFTER) {\n    var list = generateEmptyList(type);\n    var listContent = generateEmptyListContent();\n    var path = Editor.path(editor, editor.selection);\n    Transforms.insertNodes(editor, listContent, {\n      at: [path[0] + 1]\n    });\n    Transforms.select(editor, [path[0] + 1]);\n    Transforms.wrapNodes(editor, list);\n    return;\n  }\n  Editor.withoutNormalizing(editor, function () {\n    var selection = editor.selection;\n    if (!selection) return false;\n\n    // selection is collapsed, anchor === focus\n    // selection is in one block\n    if (Range.isCollapsed(selection) || !isRangeAcrossBlocks(editor)) {\n      var res = getListItemEntry(editor);\n      if (res) {\n        var _list = res.list;\n        // 选中内容的类型是另一个类型, 如： select_type: ordered_list, 将被切换为 unordered_list\n        if (_list[0].type !== type) {\n          var match = function match(n) {\n            return getListTypes().includes(getNodeType(n));\n          };\n          Transforms.setNodes(editor, {\n            type: type\n          }, {\n            at: editor.selection,\n            match: match,\n            mode: 'lowest'\n          });\n        } else {\n          unwrapList(editor);\n        }\n      } else {\n        wrapLineList(editor, type);\n      }\n      return;\n    }\n\n    // selection is a range\n    wrapRangeList(editor, type);\n  });\n};\nexport default toggleList;","map":{"version":3,"names":["_objectSpread","Node","Range","Transforms","Element","Editor","LIST_ITEM","PARAGRAPH","INSERT_POSITION","findNode","getNodeEntries","getNodeType","getSelectedNodeEntryByType","isRangeAcrossBlocks","getListItemEntry","getListTypes","unwrapList","generateEmptyList","generateEmptyListContent","generateEmptyListItem","wrapLineList","editor","type","list","wrapNodes","nodeEntry","_nodeEntry","_slicedToArray","path","listItem","at","wrapRangeList","withoutNormalizing","_Range$edges","edges","selection","_Range$edges2","startPoint","endPoint","commonAncestor","common","listTypes","includes","start","end","options","match","mode","startList","endList","rangeLength","Math","min","length","setNodes","n","isElement","rootPathLength","_nodes","nodes","Array","from","filter","_ref","_ref2","forEach","_n","toggleList","insertPosition","AFTER","listContent","insertNodes","select","isCollapsed","res"],"sources":["/Users/abel/Documents/Code-Experiments/cool-storage-api/frontend/node_modules/@seafile/sdoc-editor/dist/basic-sdk/extension/plugins/list/transforms/toggle-list.js"],"sourcesContent":["import _objectSpread from \"@babel/runtime/helpers/esm/objectSpread2\";\nimport { Node, Range, Transforms, Element, Editor } from '@seafile/slate';\nimport { LIST_ITEM, PARAGRAPH, INSERT_POSITION } from '../../../constants';\nimport { findNode, getNodeEntries, getNodeType, getSelectedNodeEntryByType, isRangeAcrossBlocks } from '../../../core';\nimport { getListItemEntry, getListTypes } from '../queries';\nimport { unwrapList } from './unwrap-list';\nimport { generateEmptyList, generateEmptyListContent, generateEmptyListItem } from '../model';\nconst wrapLineList = (editor, type) => {\n  const list = generateEmptyList(type);\n  Transforms.wrapNodes(editor, list);\n  const nodeEntry = getSelectedNodeEntryByType(editor, PARAGRAPH);\n  if (!nodeEntry) return;\n\n  // select is paragraph\n  // 1 handle paragraph\n\n  // 2 wrap list_item\n  const [, path] = nodeEntry;\n  const listItem = generateEmptyListItem();\n  Transforms.wrapNodes(editor, listItem, {\n    at: path\n  });\n  return;\n};\nconst wrapRangeList = (editor, type) => {\n  // 选中的是一个区间\n  Editor.withoutNormalizing(editor, () => {\n    // 1. 获取公共祖先\n    const [startPoint, endPoint] = Range.edges(editor.selection);\n    const commonAncestor = Node.common(editor, startPoint.path, endPoint.path);\n    const listTypes = getListTypes();\n\n    // 2. 公共祖先如果是 ordered_list | unordered_list\n    if (listTypes.includes(commonAncestor[0].type) || commonAncestor[0].type === LIST_ITEM) {\n      if (commonAncestor[0].type !== type) {\n        const start = Range.start(editor.selection);\n        const end = Range.end(editor.selection);\n        const options = {\n          at: start,\n          match: {\n            type: listTypes\n          },\n          mode: 'lowest'\n        };\n        const startList = findNode(editor, options);\n        const endList = findNode(editor, _objectSpread(_objectSpread({}, options), {\n          at: end\n        }));\n        const rangeLength = Math.min(startList[1].length, endList[1].length);\n        Transforms.setNodes(editor, {\n          type\n        }, {\n          at: editor.selection,\n          match: (n, path) => Element.isElement(n) && listTypes.includes(n.type) && path.length >= rangeLength,\n          mode: 'all'\n        });\n      } else {\n        unwrapList(editor);\n      }\n      return;\n    }\n\n    // 获取选中的所有节点的子元素\n    const rootPathLength = commonAncestor[1].length;\n    const _nodes = getNodeEntries(editor, {\n      mode: 'all'\n    });\n    const nodes = Array.from(_nodes).filter(_ref => {\n      let [, path] = _ref;\n      return path.length === rootPathLength + 1;\n    });\n    nodes.forEach(n => {\n      if (listTypes.includes(n[0].type)) {\n        Transforms.setNodes(editor, {\n          type\n        }, {\n          at: n[1],\n          match: _n => Element.isElement(_n) && listTypes.includes(_n.type),\n          mode: 'all'\n        });\n      } else {\n        // select content is paragraph\n        // 1 handle content\n\n        // 2. wrap list_item\n        const listItem = generateEmptyListItem();\n        Transforms.wrapNodes(editor, listItem, {\n          at: n[1]\n        });\n\n        // 3. wrap list\n        const list = generateEmptyList(type);\n        Transforms.wrapNodes(editor, list, {\n          at: n[1]\n        });\n      }\n    });\n  });\n};\nconst toggleList = (editor, type, insertPosition) => {\n  if (insertPosition === INSERT_POSITION.AFTER) {\n    const list = generateEmptyList(type);\n    const listContent = generateEmptyListContent();\n    const path = Editor.path(editor, editor.selection);\n    Transforms.insertNodes(editor, listContent, {\n      at: [path[0] + 1]\n    });\n    Transforms.select(editor, [path[0] + 1]);\n    Transforms.wrapNodes(editor, list);\n    return;\n  }\n  Editor.withoutNormalizing(editor, () => {\n    const {\n      selection\n    } = editor;\n    if (!selection) return false;\n\n    // selection is collapsed, anchor === focus\n    // selection is in one block\n    if (Range.isCollapsed(selection) || !isRangeAcrossBlocks(editor)) {\n      const res = getListItemEntry(editor);\n      if (res) {\n        const {\n          list\n        } = res;\n        // 选中内容的类型是另一个类型, 如： select_type: ordered_list, 将被切换为 unordered_list\n        if (list[0].type !== type) {\n          const match = n => getListTypes().includes(getNodeType(n));\n          Transforms.setNodes(editor, {\n            type\n          }, {\n            at: editor.selection,\n            match: match,\n            mode: 'lowest'\n          });\n        } else {\n          unwrapList(editor);\n        }\n      } else {\n        wrapLineList(editor, type);\n      }\n      return;\n    }\n\n    // selection is a range\n    wrapRangeList(editor, type);\n  });\n};\nexport default toggleList;"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}