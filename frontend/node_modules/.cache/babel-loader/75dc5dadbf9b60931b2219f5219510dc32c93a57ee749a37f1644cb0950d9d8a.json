{"ast":null,"code":"\"use strict\";\n\nvar _slicedToArray = require(\"/Users/abel/Documents/Code-Experiments/cool-storage-api/frontend/node_modules/@babel/runtime/helpers/slicedToArray.js\").default;\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\").default;\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = void 0;\nvar _slate = require(\"slate\");\nvar _slugid = _interopRequireDefault(require(\"slugid\"));\nvar _queries = require(\"../../core/queries\");\nvar _helper = require(\"./helper\");\nvar _elementTypes = require(\"../../constants/element-types\");\nvar _common = require(\"../../../utils/common\");\nvar _focusEditor = require(\"../../core/transforms/focus-editor\");\nvar _helper2 = require(\"../image/helper\");\nvar withLink = function withLink(editor) {\n  var isInline = editor.isInline,\n    insertBreak = editor.insertBreak,\n    deleteBackward = editor.deleteBackward,\n    insertText = editor.insertText,\n    normalizeNode = editor.normalizeNode,\n    insertData = editor.insertData;\n  var newEditor = editor;\n\n  // Rewrite isInline\n  newEditor.isInline = function (elem) {\n    var type = elem.type;\n    if (type === _elementTypes.LINK) {\n      return true;\n    }\n    return isInline(elem);\n  };\n  newEditor.insertBreak = function () {\n    var _slate$Editor$parent = _slate.Editor.parent(editor, editor.selection),\n      _slate$Editor$parent2 = _slicedToArray(_slate$Editor$parent, 2),\n      selectedElement = _slate$Editor$parent2[0],\n      path = _slate$Editor$parent2[1];\n    if (selectedElement.type === _elementTypes.LINK) {\n      var endPoint = _slate.Range.end(editor.selection);\n      var _slate$Editor$node = _slate.Editor.node(editor, endPoint),\n        _slate$Editor$node2 = _slicedToArray(_slate$Editor$node, 1),\n        selectedLeaf = _slate$Editor$node2[0];\n      if (selectedLeaf.text.length === endPoint.offset) {\n        if (_slate.Range.isExpanded(editor.selection)) {\n          _slate.Transforms.delete(editor);\n        } else {\n          _slate.Transforms.select(editor, {\n            path: _slate.Path.next(path),\n            offset: 0\n          });\n        }\n      }\n    }\n    insertBreak();\n  };\n\n  // ! bug: insertFragment will insert the same character twice in LinkNode, so we need to delete the first character\n  newEditor.insertText = function (text) {\n    var isCollapsed = _slate.Range.isCollapsed(editor.selection);\n    var path = _slate.Editor.path(editor, editor.selection);\n    var isLinkNode = (0, _queries.getSelectedNodeByType)(editor, _elementTypes.LINK);\n    var isFocusAtLinkEnd = _slate.Editor.isEnd(editor, editor.selection.focus, path);\n    if (isCollapsed && isLinkNode && isFocusAtLinkEnd) {\n      _slate.Editor.insertFragment(newEditor, [{\n        id: _slugid.default.nice(),\n        text: text\n      }]);\n      return;\n    }\n    return insertText(text);\n  };\n  newEditor.insertData = function (data) {\n    // Paste link content\n    var text = data.getData('text/plain');\n    if ((0, _common.isUrl)(text) && !(0, _common.isImage)(text)) {\n      var link = (0, _helper.generateLinkNode)(text, text);\n      _slate.Editor.insertFragment(newEditor, [link], {\n        select: true\n      });\n      return;\n    } else if ((0, _common.isUrl)(text) && (0, _common.isImage)(text)) {\n      (0, _helper2.insertImage)(newEditor, text);\n      return;\n    }\n    insertData(data);\n  };\n  newEditor.deleteBackward = function (unit) {\n    var selection = newEditor.selection;\n    if (!selection) return deleteBackward(unit);\n    // Delete link node\n    var isDeletingLinkNode = (0, _helper.isLinkType)(editor);\n    if (isDeletingLinkNode) {\n      var linkNodeInfo = (0, _helper.getLinkInfo)(editor);\n      if (linkNodeInfo && linkNodeInfo.linkTitle.length === 1) {\n        var next = _slate.Editor.next(editor);\n        var nextPath = _slate.Path.next(linkNodeInfo.path);\n        var nextNode = _slate.Editor.node(editor, nextPath);\n        (0, _focusEditor.focusEditor)(editor, next[1]);\n        _slate.Transforms.select(editor, nextNode[1]);\n        _slate.Transforms.delete(newEditor, {\n          at: linkNodeInfo.path\n        });\n        return;\n      }\n    }\n    return deleteBackward(unit);\n  };\n\n  // Rewrite normalizeNode\n  newEditor.normalizeNode = function (_ref) {\n    var _ref2 = _slicedToArray(_ref, 2),\n      node = _ref2[0],\n      path = _ref2[1];\n    var type = (0, _queries.getNodeType)(node);\n    if (type !== _elementTypes.LINK) {\n      // If the type is not link, perform default normalizeNode\n      return normalizeNode([node, path]);\n    }\n\n    // If the link is empty, delete it\n    var str = _slate.Node.string(node);\n    if (str === '') {\n      return _slate.Transforms.removeNodes(newEditor, {\n        at: path\n      });\n    }\n    return normalizeNode([node, path]);\n  };\n  return newEditor;\n};\nvar _default = exports.default = withLink;","map":{"version":3,"names":["_slicedToArray","require","default","_interopRequireDefault","Object","defineProperty","exports","value","_slate","_slugid","_queries","_helper","_elementTypes","_common","_focusEditor","_helper2","withLink","editor","isInline","insertBreak","deleteBackward","insertText","normalizeNode","insertData","newEditor","elem","type","LINK","_slate$Editor$parent","Editor","parent","selection","_slate$Editor$parent2","selectedElement","path","endPoint","Range","end","_slate$Editor$node","node","_slate$Editor$node2","selectedLeaf","text","length","offset","isExpanded","Transforms","delete","select","Path","next","isCollapsed","isLinkNode","getSelectedNodeByType","isFocusAtLinkEnd","isEnd","focus","insertFragment","id","nice","data","getData","isUrl","isImage","link","generateLinkNode","insertImage","unit","isDeletingLinkNode","isLinkType","linkNodeInfo","getLinkInfo","linkTitle","nextPath","nextNode","focusEditor","at","_ref","_ref2","getNodeType","str","Node","string","removeNodes","_default"],"sources":["/Users/abel/Documents/Code-Experiments/cool-storage-api/frontend/node_modules/@seafile/seafile-editor/dist/extension/plugins/link/plugin.js"],"sourcesContent":["\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\").default;\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = void 0;\nvar _slate = require(\"slate\");\nvar _slugid = _interopRequireDefault(require(\"slugid\"));\nvar _queries = require(\"../../core/queries\");\nvar _helper = require(\"./helper\");\nvar _elementTypes = require(\"../../constants/element-types\");\nvar _common = require(\"../../../utils/common\");\nvar _focusEditor = require(\"../../core/transforms/focus-editor\");\nvar _helper2 = require(\"../image/helper\");\nconst withLink = editor => {\n  const {\n    isInline,\n    insertBreak,\n    deleteBackward,\n    insertText,\n    normalizeNode,\n    insertData\n  } = editor;\n  const newEditor = editor;\n\n  // Rewrite isInline\n  newEditor.isInline = elem => {\n    const {\n      type\n    } = elem;\n    if (type === _elementTypes.LINK) {\n      return true;\n    }\n    return isInline(elem);\n  };\n  newEditor.insertBreak = () => {\n    const [selectedElement, path] = _slate.Editor.parent(editor, editor.selection);\n    if (selectedElement.type === _elementTypes.LINK) {\n      const endPoint = _slate.Range.end(editor.selection);\n      const [selectedLeaf] = _slate.Editor.node(editor, endPoint);\n      if (selectedLeaf.text.length === endPoint.offset) {\n        if (_slate.Range.isExpanded(editor.selection)) {\n          _slate.Transforms.delete(editor);\n        } else {\n          _slate.Transforms.select(editor, {\n            path: _slate.Path.next(path),\n            offset: 0\n          });\n        }\n      }\n    }\n    insertBreak();\n  };\n\n  // ! bug: insertFragment will insert the same character twice in LinkNode, so we need to delete the first character\n  newEditor.insertText = text => {\n    const isCollapsed = _slate.Range.isCollapsed(editor.selection);\n    const path = _slate.Editor.path(editor, editor.selection);\n    const isLinkNode = (0, _queries.getSelectedNodeByType)(editor, _elementTypes.LINK);\n    const isFocusAtLinkEnd = _slate.Editor.isEnd(editor, editor.selection.focus, path);\n    if (isCollapsed && isLinkNode && isFocusAtLinkEnd) {\n      _slate.Editor.insertFragment(newEditor, [{\n        id: _slugid.default.nice(),\n        text: text\n      }]);\n      return;\n    }\n    return insertText(text);\n  };\n  newEditor.insertData = data => {\n    // Paste link content\n    const text = data.getData('text/plain');\n    if ((0, _common.isUrl)(text) && !(0, _common.isImage)(text)) {\n      const link = (0, _helper.generateLinkNode)(text, text);\n      _slate.Editor.insertFragment(newEditor, [link], {\n        select: true\n      });\n      return;\n    } else if ((0, _common.isUrl)(text) && (0, _common.isImage)(text)) {\n      (0, _helper2.insertImage)(newEditor, text);\n      return;\n    }\n    insertData(data);\n  };\n  newEditor.deleteBackward = unit => {\n    const {\n      selection\n    } = newEditor;\n    if (!selection) return deleteBackward(unit);\n    // Delete link node\n    const isDeletingLinkNode = (0, _helper.isLinkType)(editor);\n    if (isDeletingLinkNode) {\n      const linkNodeInfo = (0, _helper.getLinkInfo)(editor);\n      if (linkNodeInfo && linkNodeInfo.linkTitle.length === 1) {\n        const next = _slate.Editor.next(editor);\n        const nextPath = _slate.Path.next(linkNodeInfo.path);\n        const nextNode = _slate.Editor.node(editor, nextPath);\n        (0, _focusEditor.focusEditor)(editor, next[1]);\n        _slate.Transforms.select(editor, nextNode[1]);\n        _slate.Transforms.delete(newEditor, {\n          at: linkNodeInfo.path\n        });\n        return;\n      }\n    }\n    return deleteBackward(unit);\n  };\n\n  // Rewrite normalizeNode\n  newEditor.normalizeNode = _ref => {\n    let [node, path] = _ref;\n    const type = (0, _queries.getNodeType)(node);\n    if (type !== _elementTypes.LINK) {\n      // If the type is not link, perform default normalizeNode\n      return normalizeNode([node, path]);\n    }\n\n    // If the link is empty, delete it\n    const str = _slate.Node.string(node);\n    if (str === '') {\n      return _slate.Transforms.removeNodes(newEditor, {\n        at: path\n      });\n    }\n    return normalizeNode([node, path]);\n  };\n  return newEditor;\n};\nvar _default = exports.default = withLink;"],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}