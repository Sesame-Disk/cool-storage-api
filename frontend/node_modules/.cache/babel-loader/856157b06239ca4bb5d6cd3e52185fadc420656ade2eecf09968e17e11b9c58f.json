{"ast":null,"code":"import _objectSpread from\"/Users/abel/Documents/Code-Experiments/cool-storage-api/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import _classCallCheck from\"/Users/abel/Documents/Code-Experiments/cool-storage-api/frontend/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";import _createClass from\"/Users/abel/Documents/Code-Experiments/cool-storage-api/frontend/node_modules/@babel/runtime/helpers/esm/createClass.js\";import _inherits from\"/Users/abel/Documents/Code-Experiments/cool-storage-api/frontend/node_modules/@babel/runtime/helpers/esm/inherits.js\";import _createSuper from\"/Users/abel/Documents/Code-Experiments/cool-storage-api/frontend/node_modules/@babel/runtime/helpers/esm/createSuper.js\";import React,{Suspense}from'react';import{MarkdownViewer}from'@seafile/seafile-editor';import{I18nextProvider}from'react-i18next';import i18n from'../../_i18n/i18n-seafile-editor';import{gettext,mediaUrl,serviceURL,sharedToken,slug}from'../../utils/constants';import{Utils}from'../../utils/utils';import Loading from'../loading';import'./style.css';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";var SeafileMarkdownViewer=/*#__PURE__*/function(_React$Component){_inherits(SeafileMarkdownViewer,_React$Component);var _super=_createSuper(SeafileMarkdownViewer);function SeafileMarkdownViewer(_props){var _this;_classCallCheck(this,SeafileMarkdownViewer);_this=_super.call(this,_props);_this.onLinkClick=function(link){_this.props.onLinkClick(link);};_this.changeInlineNode=function(item){var repoID=_this.props.repoID;var url,imagePath;// isPublicWiki: in the old version, only public wiki need replace image url\nif(item.type=='image'){// change image url\nurl=item.data.src;var re=new RegExp(serviceURL+'/lib/'+repoID+'/file.*raw=1');// different repo\nif(re.test(url)){// get image path\nvar index=url.indexOf('/file');var index2=url.indexOf('?');imagePath=url.substring(index+5,index2);}else if(/^\\.\\.\\/*/.test(url)||/^\\.\\/*/.test(url)){var path=_this.props.path;var originalPath=path.slice(0,path.lastIndexOf('/'))+'/'+url;imagePath=Utils.pathNormalize(originalPath);}else{return;}item.data.src=serviceURL+'/view-image-via-public-wiki/?slug='+slug+'&path='+imagePath;}else if(item.type=='link'){// change link url\nurl=item.url;if(Utils.isInternalFileLink(url,repoID)){// change file url\nif(Utils.isInternalMarkdownLink(url,repoID)){var _path=Utils.getPathFromInternalMarkdownLink(url,repoID);// replace url\nitem.url=serviceURL+'/published/'+slug+_path;}else{item.url=url.replace(/(.*)lib\\/([-0-9a-f]{36})\\/file(.*)/g,function(match,p1,p2,p3){return\"\".concat(p1,\"d/\").concat(sharedToken,\"/files/?p=\").concat(p3,\"&dl=1\");});}}else if(Utils.isInternalDirLink(url,repoID)){// change dir url\nvar _path2=Utils.getPathFromInternalDirLink(url,repoID);// replace url\nitem.url=serviceURL+'/published/'+slug+_path2;}}return item;};_this.modifyValueBeforeRender=function(value){var newNodes=Utils.changeMarkdownNodes(value,_this.changeInlineNode);return newNodes;};_this.renderMarkdown=function(){var _this$props=_this.props,_this$props$isTOCShow=_this$props.isTOCShow,isTOCShow=_this$props$isTOCShow===void 0?true:_this$props$isTOCShow,isWiki=_this$props.isWiki,markdownContent=_this$props.markdownContent;var props=_objectSpread({isShowOutline:isTOCShow,mathJaxSource:\"\".concat(mediaUrl,\"js/mathjax/tex-svg.js\"),value:markdownContent,scrollRef:_this.scrollRef,onLinkClick:_this.onLinkClick},isWiki&&{beforeRenderCallback:_this.modifyValueBeforeRender});return/*#__PURE__*/_jsx(I18nextProvider,{i18n:i18n,children:/*#__PURE__*/_jsx(Suspense,{fallback:/*#__PURE__*/_jsx(Loading,{}),children:/*#__PURE__*/_jsx(MarkdownViewer,_objectSpread({},props))})});};_this.scrollRef=/*#__PURE__*/React.createRef();return _this;}_createClass(SeafileMarkdownViewer,[{key:\"render\",value:function render(){if(this.props.isFileLoading){return/*#__PURE__*/_jsx(Loading,{});}var _this$props2=this.props,isWiki=_this$props2.isWiki,_this$props2$containe=_this$props2.containerClassName,containerClassName=_this$props2$containe===void 0?'':_this$props2$containe;var containerClass=\"wiki-page-container \".concat(containerClassName);// In dir-column-file width is 100%;\n// In wiki-viewer width isn't 100%\nvar contentClassName=\"wiki-page-content \".concat(!isWiki?+'w-100':'');return/*#__PURE__*/_jsx(\"div\",{ref:this.scrollRef,className:containerClass,children:/*#__PURE__*/_jsxs(\"div\",{className:contentClassName,children:[this.props.children,this.renderMarkdown(),/*#__PURE__*/_jsxs(\"p\",{id:\"wiki-page-last-modified\",children:[gettext('Last modified by'),\" \",this.props.latestContributor,\", \",/*#__PURE__*/_jsx(\"span\",{children:this.props.lastModified})]})]})});}}]);return SeafileMarkdownViewer;}(React.Component);var defaultProps={isWiki:false};SeafileMarkdownViewer.defaultProps=defaultProps;export default SeafileMarkdownViewer;","map":{"version":3,"names":["React","Suspense","MarkdownViewer","I18nextProvider","i18n","gettext","mediaUrl","serviceURL","sharedToken","slug","Utils","Loading","jsx","_jsx","jsxs","_jsxs","SeafileMarkdownViewer","_React$Component","_inherits","_super","_createSuper","props","_this","_classCallCheck","call","onLinkClick","link","changeInlineNode","item","repoID","url","imagePath","type","data","src","re","RegExp","test","index","indexOf","index2","substring","path","originalPath","slice","lastIndexOf","pathNormalize","isInternalFileLink","isInternalMarkdownLink","getPathFromInternalMarkdownLink","replace","match","p1","p2","p3","concat","isInternalDirLink","getPathFromInternalDirLink","modifyValueBeforeRender","value","newNodes","changeMarkdownNodes","renderMarkdown","_this$props","_this$props$isTOCShow","isTOCShow","isWiki","markdownContent","_objectSpread","isShowOutline","mathJaxSource","scrollRef","beforeRenderCallback","children","fallback","createRef","_createClass","key","render","isFileLoading","_this$props2","_this$props2$containe","containerClassName","containerClass","contentClassName","ref","className","id","latestContributor","lastModified","Component","defaultProps"],"sources":["/Users/abel/Documents/Code-Experiments/cool-storage-api/frontend/src/components/seafile-markdown-viewer/index.js"],"sourcesContent":["import React, { Suspense } from 'react';\nimport PropTypes from 'prop-types';\nimport { MarkdownViewer } from '@seafile/seafile-editor';\nimport { I18nextProvider } from 'react-i18next';\nimport i18n from '../../_i18n/i18n-seafile-editor';\nimport { gettext, mediaUrl, serviceURL, sharedToken, slug } from '../../utils/constants';\nimport { Utils } from '../../utils/utils';\nimport Loading from '../loading';\n\nimport './style.css';\n\nconst propTypes = {\n  isWiki: PropTypes.bool,\n  path: PropTypes.string,\n  repoID: PropTypes.string,\n  isTOCShow: PropTypes.bool,\n  children: PropTypes.object,\n  isFileLoading: PropTypes.bool.isRequired,\n  containerClassName: PropTypes.string,\n  markdownContent: PropTypes.string.isRequired,\n  latestContributor: PropTypes.string.isRequired,\n  lastModified: PropTypes.string.isRequired,\n  onLinkClick: PropTypes.func.isRequired,\n};\n\nclass SeafileMarkdownViewer extends React.Component {\n\n  constructor(props) {\n    super(props);\n    this.scrollRef = React.createRef();\n  }\n\n  onLinkClick = (link) => {\n    this.props.onLinkClick(link);\n  };\n\n  changeInlineNode = (item) => {\n    const { repoID } = this.props;\n    let url, imagePath;\n    // isPublicWiki: in the old version, only public wiki need replace image url\n    if (item.type == 'image') { // change image url\n      url = item.data.src;\n      const re = new RegExp(serviceURL + '/lib/' + repoID +'/file.*raw=1');\n      // different repo\n      if (re.test(url)) {\n        // get image path\n        let index = url.indexOf('/file');\n        let index2 = url.indexOf('?');\n        imagePath = url.substring(index + 5, index2);\n      } else if (/^\\.\\.\\/*/.test(url) || /^\\.\\/*/.test(url)) {\n        const path = this.props.path;\n        const originalPath = path.slice(0, path.lastIndexOf('/')) + '/' + url;\n        imagePath = Utils.pathNormalize(originalPath);\n      } else {\n        return;\n      }\n      item.data.src = serviceURL + '/view-image-via-public-wiki/?slug=' + slug + '&path=' + imagePath;\n    } else if (item.type == 'link') { // change link url\n      url = item.url;\n      if (Utils.isInternalFileLink(url, repoID)) { // change file url\n        if (Utils.isInternalMarkdownLink(url, repoID)) {\n          let path = Utils.getPathFromInternalMarkdownLink(url, repoID);\n          // replace url\n          item.url = serviceURL + '/published/' + slug + path;\n        } else {\n          item.url = url.replace(/(.*)lib\\/([-0-9a-f]{36})\\/file(.*)/g, (match, p1, p2, p3) => {\n            return `${p1}d/${sharedToken}/files/?p=${p3}&dl=1`;\n          });\n        }\n      } else if (Utils.isInternalDirLink(url, repoID)) { // change dir url\n        let path = Utils.getPathFromInternalDirLink(url, repoID);\n        // replace url\n        item.url = serviceURL + '/published/' + slug + path;\n      }\n    }\n\n    return item;\n  };\n\n  modifyValueBeforeRender = (value) => {\n    let newNodes = Utils.changeMarkdownNodes(value, this.changeInlineNode);\n    return newNodes;\n  };\n\n  renderMarkdown = () => {\n    const { isTOCShow = true, isWiki, markdownContent } = this.props;\n    const props = {\n      isShowOutline: isTOCShow,\n      mathJaxSource: `${mediaUrl}js/mathjax/tex-svg.js`,\n      value: markdownContent,\n      scrollRef: this.scrollRef,\n      onLinkClick: this.onLinkClick,\n      ...(isWiki && {beforeRenderCallback: this.modifyValueBeforeRender})\n    };\n\n    return (\n      <I18nextProvider i18n={ i18n }>\n        <Suspense fallback={<Loading />}>\n          <MarkdownViewer {...props} />\n        </Suspense>\n      </I18nextProvider>\n    );\n  };\n\n  render() {\n    if (this.props.isFileLoading) {\n      return <Loading />;\n    }\n    const { isWiki, containerClassName = '' } = this.props;\n    const containerClass = `wiki-page-container ${containerClassName}`;\n    // In dir-column-file width is 100%;\n    // In wiki-viewer width isn't 100%\n    const contentClassName = `wiki-page-content ${!isWiki ?  + 'w-100' : ''}`;\n    return (\n      <div ref={this.scrollRef} className={containerClass}>\n        <div className={contentClassName}>\n          {this.props.children}\n          {this.renderMarkdown()}\n          <p id=\"wiki-page-last-modified\">{gettext('Last modified by')} {this.props.latestContributor}, <span>{this.props.lastModified}</span></p>\n        </div>\n      </div>\n    );\n  }\n}\n\nconst defaultProps = {\n  isWiki: false,\n};\n\nSeafileMarkdownViewer.propTypes = propTypes;\nSeafileMarkdownViewer.defaultProps = defaultProps;\n\nexport default SeafileMarkdownViewer;\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}