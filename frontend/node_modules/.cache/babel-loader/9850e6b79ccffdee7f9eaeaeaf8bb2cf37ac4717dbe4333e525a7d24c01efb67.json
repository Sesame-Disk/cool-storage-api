{"ast":null,"code":"import _objectSpread from\"/Users/abel/Documents/Code-Experiments/cool-storage-api/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import _classCallCheck from\"/Users/abel/Documents/Code-Experiments/cool-storage-api/frontend/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";import _createClass from\"/Users/abel/Documents/Code-Experiments/cool-storage-api/frontend/node_modules/@babel/runtime/helpers/esm/createClass.js\";import _inherits from\"/Users/abel/Documents/Code-Experiments/cool-storage-api/frontend/node_modules/@babel/runtime/helpers/esm/inherits.js\";import _createSuper from\"/Users/abel/Documents/Code-Experiments/cool-storage-api/frontend/node_modules/@babel/runtime/helpers/esm/createSuper.js\";import React,{Suspense}from'react';import{WikiViewer}from'@seafile/sdoc-editor';import{I18nextProvider}from'react-i18next';import{appAvatarURL,assetsUrl,gettext,name,repoID,serviceURL,sharedToken,siteRoot,slug,username}from'../../utils/constants';import i18n from'../../_i18n/i18n-sdoc-editor';import{Utils}from'../../utils/utils';import Loading from'../loading';import'./style.css';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";var SdocWikiPageViewer=/*#__PURE__*/function(_React$Component){_inherits(SdocWikiPageViewer,_React$Component);var _super=_createSuper(SdocWikiPageViewer);function SdocWikiPageViewer(_props){var _this;_classCallCheck(this,SdocWikiPageViewer);_this=_super.call(this,_props);_this.changeInlineNode=function(item){var repoID=_this.props.repoID;var url,imagePath;// isPublicWiki: in the old version, only public wiki need replace image url\nif(item.type=='image'){// change image url\nurl=item.data.src;var re=new RegExp(serviceURL+'/lib/'+repoID+'/file.*raw=1');// different repo\nif(re.test(url)){// get image path\nvar index=url.indexOf('/file');var index2=url.indexOf('?');imagePath=url.substring(index+5,index2);}else if(/^\\.\\.\\/*/.test(url)||/^\\.\\/*/.test(url)){var path=_this.props.path;var originalPath=path.slice(0,path.lastIndexOf('/'))+'/'+url;imagePath=Utils.pathNormalize(originalPath);}else{return;}item.data.src=serviceURL+'/view-image-via-public-wiki/?slug='+slug+'&path='+imagePath;}else if(item.type=='link'){// change link url\nurl=item.url;if(Utils.isInternalFileLink(url,repoID)){// change file url\nif(Utils.isInternalMarkdownLink(url,repoID)){var _path=Utils.getPathFromInternalMarkdownLink(url,repoID);// replace url\nitem.url=serviceURL+'/published/'+slug+_path;}else{item.url=url.replace(/(.*)lib\\/([-0-9a-f]{36})\\/file(.*)/g,function(match,p1,p2,p3){return\"\".concat(p1,\"d/\").concat(sharedToken,\"/files/?p=\").concat(p3,\"&dl=1\");});}}else if(Utils.isInternalDirLink(url,repoID)){// change dir url\nvar _path2=Utils.getPathFromInternalDirLink(url,repoID);// replace url\nitem.url=serviceURL+'/published/'+slug+_path2;}}return item;};_this.modifyValueBeforeRender=function(value){var newNodes=Utils.changeMarkdownNodes(value,_this.changeInlineNode);return newNodes;};_this.renderMarkdown=function(){var _this$props=_this.props,isTOCShow=_this$props.isTOCShow,markdownContent=_this$props.markdownContent;if(!markdownContent)return null;var document=JSON.parse(markdownContent);// if (isWiki) {\n//   const newChildren = this.modifyValueBeforeRender(document.children);\n//   document.children = newChildren;\n// }\nif(!window.seafile){window.seafile={serviceUrl:serviceURL,username:username,name:name,avatarURL:appAvatarURL,repoID:repoID,siteRoot:siteRoot,assetsUrl:assetsUrl};}var props={document:document,showOutline:isTOCShow,scrollRef:_this.scrollRef};return/*#__PURE__*/_jsx(I18nextProvider,{i18n:i18n,children:/*#__PURE__*/_jsx(Suspense,{fallback:/*#__PURE__*/_jsx(Loading,{}),children:/*#__PURE__*/_jsx(WikiViewer,_objectSpread({},props))})});};_this.scrollRef=/*#__PURE__*/React.createRef();return _this;}_createClass(SdocWikiPageViewer,[{key:\"render\",value:function render(){if(this.props.isFileLoading){return/*#__PURE__*/_jsx(Loading,{});}var _this$props2=this.props,isWiki=_this$props2.isWiki,_this$props2$containe=_this$props2.containerClassName,containerClassName=_this$props2$containe===void 0?'':_this$props2$containe;var containerClass=\"wiki-page-container \".concat(containerClassName);// In dir-column-file width is 100%;\n// In wiki-viewer width isn't 100%\nvar contentClassName=\"wiki-page-content \".concat(!isWiki?+'w-100':'');return/*#__PURE__*/_jsx(\"div\",{ref:this.scrollRef,className:containerClass,children:/*#__PURE__*/_jsxs(\"div\",{className:contentClassName,children:[this.props.children,this.renderMarkdown(),/*#__PURE__*/_jsxs(\"p\",{id:\"wiki-page-last-modified\",children:[gettext('Last modified by'),\" \",this.props.latestContributor,\", \",/*#__PURE__*/_jsx(\"span\",{children:this.props.lastModified})]})]})});}}]);return SdocWikiPageViewer;}(React.Component);var defaultProps={isWiki:false,isTOCShow:true};SdocWikiPageViewer.defaultProps=defaultProps;export default SdocWikiPageViewer;","map":{"version":3,"names":["React","Suspense","WikiViewer","I18nextProvider","appAvatarURL","assetsUrl","gettext","name","repoID","serviceURL","sharedToken","siteRoot","slug","username","i18n","Utils","Loading","jsx","_jsx","jsxs","_jsxs","SdocWikiPageViewer","_React$Component","_inherits","_super","_createSuper","props","_this","_classCallCheck","call","changeInlineNode","item","url","imagePath","type","data","src","re","RegExp","test","index","indexOf","index2","substring","path","originalPath","slice","lastIndexOf","pathNormalize","isInternalFileLink","isInternalMarkdownLink","getPathFromInternalMarkdownLink","replace","match","p1","p2","p3","concat","isInternalDirLink","getPathFromInternalDirLink","modifyValueBeforeRender","value","newNodes","changeMarkdownNodes","renderMarkdown","_this$props","isTOCShow","markdownContent","document","JSON","parse","window","seafile","serviceUrl","avatarURL","showOutline","scrollRef","children","fallback","_objectSpread","createRef","_createClass","key","render","isFileLoading","_this$props2","isWiki","_this$props2$containe","containerClassName","containerClass","contentClassName","ref","className","id","latestContributor","lastModified","Component","defaultProps"],"sources":["/Users/abel/Documents/Code-Experiments/cool-storage-api/frontend/src/components/sdoc-wiki-page-viewer/index.js"],"sourcesContent":["import React, { Suspense } from 'react';\nimport PropTypes from 'prop-types';\nimport { WikiViewer } from '@seafile/sdoc-editor';\nimport { I18nextProvider } from 'react-i18next';\nimport { appAvatarURL, assetsUrl, gettext, name, repoID, serviceURL, sharedToken, siteRoot, slug, username } from '../../utils/constants';\nimport i18n from '../../_i18n/i18n-sdoc-editor';\nimport { Utils } from '../../utils/utils';\nimport Loading from '../loading';\n\nimport './style.css';\n\nconst propTypes = {\n  isWiki: PropTypes.bool,\n  path: PropTypes.string,\n  repoID: PropTypes.string,\n  isTOCShow: PropTypes.bool,\n  children: PropTypes.object,\n  isFileLoading: PropTypes.bool.isRequired,\n  containerClassName: PropTypes.string,\n  markdownContent: PropTypes.string.isRequired,\n  latestContributor: PropTypes.string.isRequired,\n  lastModified: PropTypes.string.isRequired,\n  onLinkClick: PropTypes.func.isRequired,\n};\n\nclass SdocWikiPageViewer extends React.Component {\n\n  constructor(props) {\n    super(props);\n    this.scrollRef = React.createRef();\n  }\n\n  changeInlineNode = (item) => {\n    const { repoID } = this.props;\n    let url, imagePath;\n    // isPublicWiki: in the old version, only public wiki need replace image url\n    if (item.type == 'image') { // change image url\n      url = item.data.src;\n      const re = new RegExp(serviceURL + '/lib/' + repoID +'/file.*raw=1');\n      // different repo\n      if (re.test(url)) {\n        // get image path\n        let index = url.indexOf('/file');\n        let index2 = url.indexOf('?');\n        imagePath = url.substring(index + 5, index2);\n      } else if (/^\\.\\.\\/*/.test(url) || /^\\.\\/*/.test(url)) {\n        const path = this.props.path;\n        const originalPath = path.slice(0, path.lastIndexOf('/')) + '/' + url;\n        imagePath = Utils.pathNormalize(originalPath);\n      } else {\n        return;\n      }\n      item.data.src = serviceURL + '/view-image-via-public-wiki/?slug=' + slug + '&path=' + imagePath;\n    } else if (item.type == 'link') { // change link url\n      url = item.url;\n      if (Utils.isInternalFileLink(url, repoID)) { // change file url\n        if (Utils.isInternalMarkdownLink(url, repoID)) {\n          let path = Utils.getPathFromInternalMarkdownLink(url, repoID);\n          // replace url\n          item.url = serviceURL + '/published/' + slug + path;\n        } else {\n          item.url = url.replace(/(.*)lib\\/([-0-9a-f]{36})\\/file(.*)/g, (match, p1, p2, p3) => {\n            return `${p1}d/${sharedToken}/files/?p=${p3}&dl=1`;\n          });\n        }\n      } else if (Utils.isInternalDirLink(url, repoID)) { // change dir url\n        let path = Utils.getPathFromInternalDirLink(url, repoID);\n        // replace url\n        item.url = serviceURL + '/published/' + slug + path;\n      }\n    }\n\n    return item;\n  };\n\n  modifyValueBeforeRender = (value) => {\n    let newNodes = Utils.changeMarkdownNodes(value, this.changeInlineNode);\n    return newNodes;\n  };\n\n  renderMarkdown = () => {\n    let { isTOCShow, markdownContent } = this.props;\n    if (!markdownContent) return null;\n\n    let document = JSON.parse(markdownContent);\n    // if (isWiki) {\n    //   const newChildren = this.modifyValueBeforeRender(document.children);\n    //   document.children = newChildren;\n    // }\n\n    if (!window.seafile) {\n      window.seafile = {\n        serviceUrl: serviceURL,\n        username: username,\n        name: name,\n        avatarURL: appAvatarURL,\n        repoID: repoID,\n        siteRoot: siteRoot,\n        assetsUrl: assetsUrl,\n      };\n    }\n\n    const props = {\n      document: document,\n      showOutline: isTOCShow,\n      scrollRef: this.scrollRef,\n    };\n\n    return (\n      <I18nextProvider i18n={ i18n }>\n        <Suspense fallback={<Loading />}>\n          <WikiViewer {...props} />\n        </Suspense>\n      </I18nextProvider>\n    );\n  };\n\n  render() {\n    if (this.props.isFileLoading) {\n      return <Loading />;\n    }\n\n    const { isWiki, containerClassName = '' } = this.props;\n    const containerClass = `wiki-page-container ${containerClassName}`;\n    // In dir-column-file width is 100%;\n    // In wiki-viewer width isn't 100%\n    const contentClassName = `wiki-page-content ${!isWiki ?  + 'w-100' : ''}`;\n    return (\n      <div ref={this.scrollRef} className={containerClass}>\n        <div className={contentClassName}>\n          {this.props.children}\n          {this.renderMarkdown()}\n          <p id=\"wiki-page-last-modified\">{gettext('Last modified by')} {this.props.latestContributor}, <span>{this.props.lastModified}</span></p>\n        </div>\n      </div>\n    );\n  }\n}\n\nconst defaultProps = {\n  isWiki: false,\n  isTOCShow: true,\n};\n\nSdocWikiPageViewer.propTypes = propTypes;\nSdocWikiPageViewer.defaultProps = defaultProps;\n\nexport default SdocWikiPageViewer;\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}