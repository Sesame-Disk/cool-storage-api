{"ast":null,"code":"import _slicedToArray from \"/Users/abel/Documents/Code-Experiments/cool-storage-api/frontend/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";\nimport { Transforms, Node, Editor, Range, Element } from '@seafile/slate';\nimport isUrl from 'is-url';\nimport context from '../../../../context';\nimport { insertSdocFileLink } from '../sdoc-link/helpers';\nimport { genLinkNode, isSdocFile } from './helpers';\nimport { getNodeType, getSelectedNodeByType } from '../../core';\nimport { isImage, isSameDomain } from '../../utils';\nimport { LINK, ORDERED_LIST, UNORDERED_LIST } from '../../constants';\nvar withLink = function withLink(editor) {\n  var normalizeNode = editor.normalizeNode,\n    isInline = editor.isInline,\n    insertData = editor.insertData,\n    insertFragment = editor.insertFragment;\n  var newEditor = editor;\n\n  // Rewrite isInline\n  newEditor.isInline = function (elem) {\n    var type = elem.type;\n    if (type === LINK) {\n      return true;\n    }\n    return isInline(elem);\n  };\n  newEditor.insertData = function (data) {\n    // Paste link content\n    var text = data.getData('text/plain');\n    if (isUrl(text) && !isImage(text)) {\n      var link = genLinkNode(text, text);\n      Transforms.insertNodes(newEditor, link);\n      if (isSameDomain(text, context.getSetting('serviceUrl'))) {\n        context.getLinkFilesInfo([text]).then(function (res) {\n          if (isSdocFile(res, text)) {\n            var _Editor$nodes = Editor.nodes(editor, {\n                match: function match(n) {\n                  return n.type === LINK;\n                },\n                universal: true\n              }),\n              _Editor$nodes2 = _slicedToArray(_Editor$nodes, 1),\n              nodeEntry = _Editor$nodes2[0];\n            var fileName = res.data.files_info[text].name;\n            var fileUuid = res.data.files_info[text].file_uuid;\n            Transforms.removeNodes(editor, {\n              at: nodeEntry[1]\n            });\n            insertSdocFileLink(editor, fileName, fileUuid);\n            return;\n          }\n        });\n      }\n      return;\n    }\n    insertData(data);\n  };\n  newEditor.insertFragment = function (data) {\n    // Paste into link\n    if (getSelectedNodeByType(newEditor, LINK)) {\n      var fragments = data.slice(0).filter(function (item) {\n        return Node.string(item).length !== 0;\n      });\n      // Prevent list into link\n      if (fragments.some(function (item) {\n        return [ORDERED_LIST, UNORDERED_LIST].includes(item.type);\n      })) {\n        return;\n      }\n    }\n    return insertFragment(data);\n  };\n\n  // Rewrite normalizeNode\n  newEditor.normalizeNode = function (_ref) {\n    var _ref2 = _slicedToArray(_ref, 2),\n      node = _ref2[0],\n      path = _ref2[1];\n    var type = getNodeType(node);\n    if (type !== LINK) {\n      // If the type is not link, perform default normalizeNode\n      return normalizeNode([node, path]);\n    }\n\n    // If the link is empty, delete it\n    var str = Node.string(node);\n    if (str === '') {\n      return Transforms.removeNodes(newEditor, {\n        at: path\n      });\n    }\n    return normalizeNode([node, path]);\n  };\n  editor.onCompositionStart = function (e) {\n    var selection = editor.selection;\n    if (Range.isCollapsed(selection)) {\n      var _Editor$nodes3 = Editor.nodes(editor, {\n          match: function match(n) {\n            return Element.isElement && n.type === LINK;\n          }\n        }),\n        _Editor$nodes4 = _slicedToArray(_Editor$nodes3, 1),\n        LinkNodeEntry = _Editor$nodes4[0];\n      if (LinkNodeEntry) {\n        e.preventDefault();\n        return true;\n      }\n    }\n  };\n  return newEditor;\n};\nexport default withLink;","map":{"version":3,"names":["Transforms","Node","Editor","Range","Element","isUrl","context","insertSdocFileLink","genLinkNode","isSdocFile","getNodeType","getSelectedNodeByType","isImage","isSameDomain","LINK","ORDERED_LIST","UNORDERED_LIST","withLink","editor","normalizeNode","isInline","insertData","insertFragment","newEditor","elem","type","data","text","getData","link","insertNodes","getSetting","getLinkFilesInfo","then","res","_Editor$nodes","nodes","match","n","universal","_Editor$nodes2","_slicedToArray","nodeEntry","fileName","files_info","name","fileUuid","file_uuid","removeNodes","at","fragments","slice","filter","item","string","length","some","includes","_ref","_ref2","node","path","str","onCompositionStart","e","selection","isCollapsed","_Editor$nodes3","isElement","_Editor$nodes4","LinkNodeEntry","preventDefault"],"sources":["/Users/abel/Documents/Code-Experiments/cool-storage-api/frontend/node_modules/@seafile/sdoc-editor/dist/basic-sdk/extension/plugins/link/plugin.js"],"sourcesContent":["import { Transforms, Node, Editor, Range, Element } from '@seafile/slate';\nimport isUrl from 'is-url';\nimport context from '../../../../context';\nimport { insertSdocFileLink } from '../sdoc-link/helpers';\nimport { genLinkNode, isSdocFile } from './helpers';\nimport { getNodeType, getSelectedNodeByType } from '../../core';\nimport { isImage, isSameDomain } from '../../utils';\nimport { LINK, ORDERED_LIST, UNORDERED_LIST } from '../../constants';\nconst withLink = editor => {\n  const {\n    normalizeNode,\n    isInline,\n    insertData,\n    insertFragment\n  } = editor;\n  const newEditor = editor;\n\n  // Rewrite isInline\n  newEditor.isInline = elem => {\n    const {\n      type\n    } = elem;\n    if (type === LINK) {\n      return true;\n    }\n    return isInline(elem);\n  };\n  newEditor.insertData = data => {\n    // Paste link content\n    const text = data.getData('text/plain');\n    if (isUrl(text) && !isImage(text)) {\n      const link = genLinkNode(text, text);\n      Transforms.insertNodes(newEditor, link);\n      if (isSameDomain(text, context.getSetting('serviceUrl'))) {\n        context.getLinkFilesInfo([text]).then(res => {\n          if (isSdocFile(res, text)) {\n            const [nodeEntry] = Editor.nodes(editor, {\n              match: n => n.type === LINK,\n              universal: true\n            });\n            const fileName = res.data.files_info[text].name;\n            const fileUuid = res.data.files_info[text].file_uuid;\n            Transforms.removeNodes(editor, {\n              at: nodeEntry[1]\n            });\n            insertSdocFileLink(editor, fileName, fileUuid);\n            return;\n          }\n        });\n      }\n      return;\n    }\n    insertData(data);\n  };\n  newEditor.insertFragment = data => {\n    // Paste into link\n    if (getSelectedNodeByType(newEditor, LINK)) {\n      const fragments = data.slice(0).filter(item => Node.string(item).length !== 0);\n      // Prevent list into link\n      if (fragments.some(item => [ORDERED_LIST, UNORDERED_LIST].includes(item.type))) {\n        return;\n      }\n    }\n    return insertFragment(data);\n  };\n\n  // Rewrite normalizeNode\n  newEditor.normalizeNode = _ref => {\n    let [node, path] = _ref;\n    const type = getNodeType(node);\n    if (type !== LINK) {\n      // If the type is not link, perform default normalizeNode\n      return normalizeNode([node, path]);\n    }\n\n    // If the link is empty, delete it\n    const str = Node.string(node);\n    if (str === '') {\n      return Transforms.removeNodes(newEditor, {\n        at: path\n      });\n    }\n    return normalizeNode([node, path]);\n  };\n  editor.onCompositionStart = e => {\n    const {\n      selection\n    } = editor;\n    if (Range.isCollapsed(selection)) {\n      const [LinkNodeEntry] = Editor.nodes(editor, {\n        match: n => Element.isElement && n.type === LINK\n      });\n      if (LinkNodeEntry) {\n        e.preventDefault();\n        return true;\n      }\n    }\n  };\n  return newEditor;\n};\nexport default withLink;"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}