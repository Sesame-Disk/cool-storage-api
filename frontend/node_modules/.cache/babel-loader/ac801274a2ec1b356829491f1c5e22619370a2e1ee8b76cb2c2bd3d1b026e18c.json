{"ast":null,"code":"import _slicedToArray from \"/Users/abel/Documents/Code-Experiments/cool-storage-api/frontend/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";\nimport _toConsumableArray from \"/Users/abel/Documents/Code-Experiments/cool-storage-api/frontend/node_modules/@babel/runtime/helpers/esm/toConsumableArray.js\";\nimport _createForOfIteratorHelper from \"/Users/abel/Documents/Code-Experiments/cool-storage-api/frontend/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper.js\";\nimport _objectSpread from \"@babel/runtime/helpers/esm/objectSpread2\";\nimport { Node, Element, Editor } from '@seafile/slate';\nimport { useSlateStatic } from '@seafile/slate-react';\nimport Prism, { normalizeTokens, normalizeTokensByLanguageType } from '../extension/plugins/code-block/prismjs';\nimport { CODE_BLOCK } from '../extension/constants';\nimport { getValidLang } from '../extension/plugins/code-block/helpers';\nvar mergeMaps = function mergeMaps() {\n  var map = new Map();\n  for (var _len = arguments.length, maps = new Array(_len), _key = 0; _key < _len; _key++) {\n    maps[_key] = arguments[_key];\n  }\n  for (var _i = 0, _maps = maps; _i < _maps.length; _i++) {\n    var m = _maps[_i];\n    var _iterator = _createForOfIteratorHelper(m),\n      _step;\n    try {\n      for (_iterator.s(); !(_step = _iterator.n()).done;) {\n        var item = _step.value;\n        map.set.apply(map, _toConsumableArray(item));\n      }\n    } catch (err) {\n      _iterator.e(err);\n    } finally {\n      _iterator.f();\n    }\n  }\n  return map;\n};\nvar getChildNodeToDecorations = function getChildNodeToDecorations(_ref) {\n  var _ref2 = _slicedToArray(_ref, 2),\n    block = _ref2[0],\n    blockPath = _ref2[1];\n  var nodeToDecorations = new Map();\n  var text = block.children.map(function (line) {\n    return Node.string(line);\n  }).join('\\n');\n  var language = getValidLang(block.language);\n  var tokens = Prism.tokenize(text, Prism.languages[language]);\n  if (Object.keys(normalizeTokensByLanguageType).includes(language)) {\n    tokens = normalizeTokensByLanguageType[language](tokens);\n  }\n  var normalizedTokens = normalizeTokens(tokens); // make tokens flat and grouped by line\n  var blockChildren = block.children;\n  for (var index = 0; index < normalizedTokens.length; index++) {\n    var _tokens = normalizedTokens[index];\n    var element = blockChildren[index];\n    if (element) {\n      if (!nodeToDecorations.has(element)) {\n        nodeToDecorations.set(element, []);\n      }\n    }\n    var start = 0;\n    var _iterator2 = _createForOfIteratorHelper(_tokens),\n      _step2;\n    try {\n      for (_iterator2.s(); !(_step2 = _iterator2.n()).done;) {\n        var token = _step2.value;\n        var length = token.content.length;\n        if (!length) {\n          continue;\n        }\n        var end = start + length;\n        var path = [].concat(_toConsumableArray(blockPath), [index, 0]);\n        var range = _objectSpread({\n          anchor: {\n            path: path,\n            offset: start\n          },\n          focus: {\n            path: path,\n            offset: end\n          },\n          token: true\n        }, Object.fromEntries(token.types.map(function (type) {\n          return [type, true];\n        })));\n        if (nodeToDecorations.get(element)) {\n          nodeToDecorations.get(element).push(range);\n        }\n        start = end;\n      }\n    } catch (err) {\n      _iterator2.e(err);\n    } finally {\n      _iterator2.f();\n    }\n  }\n  return nodeToDecorations;\n};\nexport var SetNodeToDecorations = function SetNodeToDecorations() {\n  var editor = useSlateStatic();\n  var blockEntries = Array.from(Editor.nodes(editor, {\n    at: [],\n    mode: 'highest',\n    match: function match(n) {\n      return Element.isElement(n) && n.type === CODE_BLOCK;\n    }\n  }));\n  var nodeToDecorations = mergeMaps.apply(void 0, _toConsumableArray(blockEntries.map(getChildNodeToDecorations)));\n  editor.nodeToDecorations = nodeToDecorations;\n  return null;\n};","map":{"version":3,"names":["_objectSpread","Node","Element","Editor","useSlateStatic","Prism","normalizeTokens","normalizeTokensByLanguageType","CODE_BLOCK","getValidLang","mergeMaps","map","Map","_len","arguments","length","maps","Array","_key","_i","_maps","m","_iterator","_createForOfIteratorHelper","_step","s","n","done","item","value","set","apply","_toConsumableArray","err","e","f","getChildNodeToDecorations","_ref","_ref2","_slicedToArray","block","blockPath","nodeToDecorations","text","children","line","string","join","language","tokens","tokenize","languages","Object","keys","includes","normalizedTokens","blockChildren","index","element","has","start","_iterator2","_step2","token","content","end","path","concat","range","anchor","offset","focus","fromEntries","types","type","get","push","SetNodeToDecorations","editor","blockEntries","from","nodes","at","mode","match","isElement"],"sources":["/Users/abel/Documents/Code-Experiments/cool-storage-api/frontend/node_modules/@seafile/sdoc-editor/dist/basic-sdk/highlight/setNodeToDecorations.js"],"sourcesContent":["import _objectSpread from \"@babel/runtime/helpers/esm/objectSpread2\";\nimport { Node, Element, Editor } from '@seafile/slate';\nimport { useSlateStatic } from '@seafile/slate-react';\nimport Prism, { normalizeTokens, normalizeTokensByLanguageType } from '../extension/plugins/code-block/prismjs';\nimport { CODE_BLOCK } from '../extension/constants';\nimport { getValidLang } from '../extension/plugins/code-block/helpers';\nconst mergeMaps = function () {\n  const map = new Map();\n  for (var _len = arguments.length, maps = new Array(_len), _key = 0; _key < _len; _key++) {\n    maps[_key] = arguments[_key];\n  }\n  for (const m of maps) {\n    for (const item of m) {\n      map.set(...item);\n    }\n  }\n  return map;\n};\nconst getChildNodeToDecorations = _ref => {\n  let [block, blockPath] = _ref;\n  const nodeToDecorations = new Map();\n  const text = block.children.map(line => Node.string(line)).join('\\n');\n  const language = getValidLang(block.language);\n  let tokens = Prism.tokenize(text, Prism.languages[language]);\n  if (Object.keys(normalizeTokensByLanguageType).includes(language)) {\n    tokens = normalizeTokensByLanguageType[language](tokens);\n  }\n  const normalizedTokens = normalizeTokens(tokens); // make tokens flat and grouped by line\n  const blockChildren = block.children;\n  for (let index = 0; index < normalizedTokens.length; index++) {\n    const tokens = normalizedTokens[index];\n    const element = blockChildren[index];\n    if (element) {\n      if (!nodeToDecorations.has(element)) {\n        nodeToDecorations.set(element, []);\n      }\n    }\n    let start = 0;\n    for (const token of tokens) {\n      const length = token.content.length;\n      if (!length) {\n        continue;\n      }\n      const end = start + length;\n      const path = [...blockPath, index, 0];\n      const range = _objectSpread({\n        anchor: {\n          path,\n          offset: start\n        },\n        focus: {\n          path,\n          offset: end\n        },\n        token: true\n      }, Object.fromEntries(token.types.map(type => [type, true])));\n      if (nodeToDecorations.get(element)) {\n        nodeToDecorations.get(element).push(range);\n      }\n      start = end;\n    }\n  }\n  return nodeToDecorations;\n};\nexport const SetNodeToDecorations = () => {\n  const editor = useSlateStatic();\n  const blockEntries = Array.from(Editor.nodes(editor, {\n    at: [],\n    mode: 'highest',\n    match: n => Element.isElement(n) && n.type === CODE_BLOCK\n  }));\n  const nodeToDecorations = mergeMaps(...blockEntries.map(getChildNodeToDecorations));\n  editor.nodeToDecorations = nodeToDecorations;\n  return null;\n};"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}