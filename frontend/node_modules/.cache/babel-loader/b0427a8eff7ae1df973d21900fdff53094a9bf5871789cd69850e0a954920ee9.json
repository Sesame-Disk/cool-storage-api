{"ast":null,"code":"import { generateCursorData } from '../cursor/helper';\nimport EventBus from '../utils/event-bus';\nimport SocketManager from './socket-manager';\nvar withSocketIO = function withSocketIO(editor, options) {\n  var onChange = editor.onChange;\n  var newEditor = editor;\n  var socketManager = null;\n  var user = options.config.user;\n  newEditor.user = user;\n  newEditor.openConnection = function () {\n    var document = options.document,\n      config = options.config;\n    var cursorData = generateCursorData(options.config);\n    config['cursorData'] = cursorData;\n    socketManager = SocketManager.getInstance(newEditor, document, config);\n  };\n  newEditor.closeConnection = function () {\n    socketManager && socketManager.closeSocketConnect();\n    SocketManager.destroy();\n  };\n  newEditor.onChange = function () {\n    if (newEditor.readonly) return;\n    var document = options.document,\n      config = options.config;\n    var operations = newEditor.operations;\n    if (!newEditor.isRemote && operations.length > 0) {\n      var isAllSetSelection = operations.every(function (operation) {\n        return operation.type === 'set_selection';\n      });\n      var _socketManager = SocketManager.getInstance(newEditor, document, config);\n      if (!isAllSetSelection) {\n        // get update content value operations\n        var updateOperations = operations.filter(function (operation) {\n          return operation.type !== 'set_selection';\n        });\n        _socketManager.onReceiveLocalOperations(updateOperations);\n      }\n      _socketManager.sendCursorLocation(editor.selection);\n    }\n\n    // dispatch editor change event\n    var eventBus = EventBus.getInstance(newEditor, document, config);\n    eventBus.dispatch('change');\n    onChange();\n  };\n  newEditor.rebaseContent = function (document, originFileVersion) {\n    var config = options.config;\n    var socketManager = SocketManager.getInstance(newEditor, document, config);\n    socketManager.sendRebaseContent(document, originFileVersion);\n  };\n  newEditor.updateDocumentVersion = function (document) {\n    var config = options.config;\n    var socketManager = SocketManager.getInstance(newEditor, document, config);\n    socketManager.updateDocumentVersion(document);\n  };\n  return newEditor;\n};\nexport default withSocketIO;","map":{"version":3,"names":["generateCursorData","EventBus","SocketManager","withSocketIO","editor","options","onChange","newEditor","socketManager","user","config","openConnection","document","cursorData","getInstance","closeConnection","closeSocketConnect","destroy","readonly","operations","isRemote","length","isAllSetSelection","every","operation","type","updateOperations","filter","onReceiveLocalOperations","sendCursorLocation","selection","eventBus","dispatch","rebaseContent","originFileVersion","sendRebaseContent","updateDocumentVersion"],"sources":["/Users/abel/Documents/Code-Experiments/cool-storage-api/frontend/node_modules/@seafile/sdoc-editor/dist/basic-sdk/socket/with-socket-io.js"],"sourcesContent":["import { generateCursorData } from '../cursor/helper';\nimport EventBus from '../utils/event-bus';\nimport SocketManager from './socket-manager';\nconst withSocketIO = (editor, options) => {\n  const {\n    onChange\n  } = editor;\n  const newEditor = editor;\n  let socketManager = null;\n  const {\n    user\n  } = options.config;\n  newEditor.user = user;\n  newEditor.openConnection = () => {\n    const {\n      document,\n      config\n    } = options;\n    const cursorData = generateCursorData(options.config);\n    config['cursorData'] = cursorData;\n    socketManager = SocketManager.getInstance(newEditor, document, config);\n  };\n  newEditor.closeConnection = () => {\n    socketManager && socketManager.closeSocketConnect();\n    SocketManager.destroy();\n  };\n  newEditor.onChange = () => {\n    if (newEditor.readonly) return;\n    const {\n      document,\n      config\n    } = options;\n    let operations = newEditor.operations;\n    if (!newEditor.isRemote && operations.length > 0) {\n      const isAllSetSelection = operations.every(operation => operation.type === 'set_selection');\n      const socketManager = SocketManager.getInstance(newEditor, document, config);\n      if (!isAllSetSelection) {\n        // get update content value operations\n        const updateOperations = operations.filter(operation => operation.type !== 'set_selection');\n        socketManager.onReceiveLocalOperations(updateOperations);\n      }\n      socketManager.sendCursorLocation(editor.selection);\n    }\n\n    // dispatch editor change event\n    const eventBus = EventBus.getInstance(newEditor, document, config);\n    eventBus.dispatch('change');\n    onChange();\n  };\n  newEditor.rebaseContent = (document, originFileVersion) => {\n    const {\n      config\n    } = options;\n    const socketManager = SocketManager.getInstance(newEditor, document, config);\n    socketManager.sendRebaseContent(document, originFileVersion);\n  };\n  newEditor.updateDocumentVersion = document => {\n    const {\n      config\n    } = options;\n    const socketManager = SocketManager.getInstance(newEditor, document, config);\n    socketManager.updateDocumentVersion(document);\n  };\n  return newEditor;\n};\nexport default withSocketIO;"],"mappings":"AAAA,SAASA,kBAAkB,QAAQ,kBAAkB;AACrD,OAAOC,QAAQ,MAAM,oBAAoB;AACzC,OAAOC,aAAa,MAAM,kBAAkB;AAC5C,IAAMC,YAAY,GAAG,SAAfA,YAAYA,CAAIC,MAAM,EAAEC,OAAO,EAAK;EACxC,IACEC,QAAQ,GACNF,MAAM,CADRE,QAAQ;EAEV,IAAMC,SAAS,GAAGH,MAAM;EACxB,IAAII,aAAa,GAAG,IAAI;EACxB,IACEC,IAAI,GACFJ,OAAO,CAACK,MAAM,CADhBD,IAAI;EAENF,SAAS,CAACE,IAAI,GAAGA,IAAI;EACrBF,SAAS,CAACI,cAAc,GAAG,YAAM;IAC/B,IACEC,QAAQ,GAENP,OAAO,CAFTO,QAAQ;MACRF,MAAM,GACJL,OAAO,CADTK,MAAM;IAER,IAAMG,UAAU,GAAGb,kBAAkB,CAACK,OAAO,CAACK,MAAM,CAAC;IACrDA,MAAM,CAAC,YAAY,CAAC,GAAGG,UAAU;IACjCL,aAAa,GAAGN,aAAa,CAACY,WAAW,CAACP,SAAS,EAAEK,QAAQ,EAAEF,MAAM,CAAC;EACxE,CAAC;EACDH,SAAS,CAACQ,eAAe,GAAG,YAAM;IAChCP,aAAa,IAAIA,aAAa,CAACQ,kBAAkB,CAAC,CAAC;IACnDd,aAAa,CAACe,OAAO,CAAC,CAAC;EACzB,CAAC;EACDV,SAAS,CAACD,QAAQ,GAAG,YAAM;IACzB,IAAIC,SAAS,CAACW,QAAQ,EAAE;IACxB,IACEN,QAAQ,GAENP,OAAO,CAFTO,QAAQ;MACRF,MAAM,GACJL,OAAO,CADTK,MAAM;IAER,IAAIS,UAAU,GAAGZ,SAAS,CAACY,UAAU;IACrC,IAAI,CAACZ,SAAS,CAACa,QAAQ,IAAID,UAAU,CAACE,MAAM,GAAG,CAAC,EAAE;MAChD,IAAMC,iBAAiB,GAAGH,UAAU,CAACI,KAAK,CAAC,UAAAC,SAAS;QAAA,OAAIA,SAAS,CAACC,IAAI,KAAK,eAAe;MAAA,EAAC;MAC3F,IAAMjB,cAAa,GAAGN,aAAa,CAACY,WAAW,CAACP,SAAS,EAAEK,QAAQ,EAAEF,MAAM,CAAC;MAC5E,IAAI,CAACY,iBAAiB,EAAE;QACtB;QACA,IAAMI,gBAAgB,GAAGP,UAAU,CAACQ,MAAM,CAAC,UAAAH,SAAS;UAAA,OAAIA,SAAS,CAACC,IAAI,KAAK,eAAe;QAAA,EAAC;QAC3FjB,cAAa,CAACoB,wBAAwB,CAACF,gBAAgB,CAAC;MAC1D;MACAlB,cAAa,CAACqB,kBAAkB,CAACzB,MAAM,CAAC0B,SAAS,CAAC;IACpD;;IAEA;IACA,IAAMC,QAAQ,GAAG9B,QAAQ,CAACa,WAAW,CAACP,SAAS,EAAEK,QAAQ,EAAEF,MAAM,CAAC;IAClEqB,QAAQ,CAACC,QAAQ,CAAC,QAAQ,CAAC;IAC3B1B,QAAQ,CAAC,CAAC;EACZ,CAAC;EACDC,SAAS,CAAC0B,aAAa,GAAG,UAACrB,QAAQ,EAAEsB,iBAAiB,EAAK;IACzD,IACExB,MAAM,GACJL,OAAO,CADTK,MAAM;IAER,IAAMF,aAAa,GAAGN,aAAa,CAACY,WAAW,CAACP,SAAS,EAAEK,QAAQ,EAAEF,MAAM,CAAC;IAC5EF,aAAa,CAAC2B,iBAAiB,CAACvB,QAAQ,EAAEsB,iBAAiB,CAAC;EAC9D,CAAC;EACD3B,SAAS,CAAC6B,qBAAqB,GAAG,UAAAxB,QAAQ,EAAI;IAC5C,IACEF,MAAM,GACJL,OAAO,CADTK,MAAM;IAER,IAAMF,aAAa,GAAGN,aAAa,CAACY,WAAW,CAACP,SAAS,EAAEK,QAAQ,EAAEF,MAAM,CAAC;IAC5EF,aAAa,CAAC4B,qBAAqB,CAACxB,QAAQ,CAAC;EAC/C,CAAC;EACD,OAAOL,SAAS;AAClB,CAAC;AACD,eAAeJ,YAAY"},"metadata":{},"sourceType":"module","externalDependencies":[]}