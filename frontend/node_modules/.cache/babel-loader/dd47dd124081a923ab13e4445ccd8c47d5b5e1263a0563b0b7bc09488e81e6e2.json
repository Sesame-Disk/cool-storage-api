{"ast":null,"code":"import _classCallCheck from\"/Users/abel/Documents/Code-Experiments/cool-storage-api/frontend/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";import _createClass from\"/Users/abel/Documents/Code-Experiments/cool-storage-api/frontend/node_modules/@babel/runtime/helpers/esm/createClass.js\";import _inherits from\"/Users/abel/Documents/Code-Experiments/cool-storage-api/frontend/node_modules/@babel/runtime/helpers/esm/inherits.js\";import _createSuper from\"/Users/abel/Documents/Code-Experiments/cool-storage-api/frontend/node_modules/@babel/runtime/helpers/esm/createSuper.js\";import React from'react';import{Modal,ModalHeader,ModalBody}from'reactstrap';import{mediaUrl,gettext,fileServerRoot}from'../../utils/constants';import{seafileAPI}from'../../utils/seafile-api';import{Utils}from'../../utils/utils';import Loading from'../loading';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";var interval;var ZipDownloadDialog=/*#__PURE__*/function(_React$Component){_inherits(ZipDownloadDialog,_React$Component);var _super=_createSuper(ZipDownloadDialog);function ZipDownloadDialog(props){var _this;_classCallCheck(this,ZipDownloadDialog);_this=_super.call(this,props);_this.queryZipProgress=function(){var zipToken=_this.state.zipToken;seafileAPI.queryZipProgress(zipToken).then(function(res){var data=res.data;if(data.failed==1){clearInterval(interval);var errorMsg;switch(data.failed_reason){// returned from seaserv\ncase'size too large':errorMsg=gettext('Failed to download. The total size of the files exceeded the limit.');break;case'internal error':errorMsg=gettext('Internal Server Error');break;default:errorMsg=gettext('Error');}_this.setState({isLoading:false,errorMsg:errorMsg});}else{_this.setState({zipProgress:data.total==0?'100%':(data.zipped/data.total*100).toFixed(2)+'%'});if(data['total']==data['zipped']){clearInterval(interval);_this.props.toggleDialog();location.href=\"\".concat(fileServerRoot,\"zip/\").concat(zipToken);}}}).catch(function(error){clearInterval(interval);var errorMsg=Utils.getErrorMsg(error);_this.setState({isLoading:false,errorMsg:errorMsg});});};_this.cancelZipTask=function(){var zipToken=_this.state.zipToken;seafileAPI.cancelZipTask(zipToken).then(function(res){// do nothing\n}).catch(function(error){// do nothing\n});};_this.toggleDialog=function(){var zipProgress=_this.state.zipProgress;if(zipProgress&&zipProgress!='100%'){clearInterval(interval);_this.cancelZipTask();}_this.props.toggleDialog();};_this.state={isLoading:true,errorMsg:'',zipProgress:null};return _this;}_createClass(ZipDownloadDialog,[{key:\"componentDidMount\",value:function componentDidMount(){var _this2=this;var _this$props=this.props,token=_this$props.token,path=_this$props.path,repoID=_this$props.repoID,target=_this$props.target;var getZipTask;if(token){getZipTask=target.length?seafileAPI.getShareLinkDirentsZipTask(token,path,target):seafileAPI.getShareLinkZipTask(token,path);}else{getZipTask=seafileAPI.zipDownload(repoID,path,target);}getZipTask.then(function(res){var zipToken=res.data['zip_token'];_this2.setState({isLoading:false,errorMsg:'',zipToken:zipToken});_this2.queryZipProgress();interval=setInterval(_this2.queryZipProgress,1000);}).catch(function(error){var errorMsg=Utils.getErrorMsg(error);_this2.setState({isLoading:false,errorMsg:errorMsg});});}},{key:\"render\",value:function render(){return/*#__PURE__*/_jsxs(Modal,{isOpen:true,toggle:this.toggleDialog,children:[/*#__PURE__*/_jsx(ModalHeader,{toggle:this.toggleDialog,children:gettext('Download')}),/*#__PURE__*/_jsx(ModalBody,{children:/*#__PURE__*/_jsx(Content,{data:this.state})})]});}}]);return ZipDownloadDialog;}(React.Component);var Content=/*#__PURE__*/function(_React$Component2){_inherits(Content,_React$Component2);var _super2=_createSuper(Content);function Content(){_classCallCheck(this,Content);return _super2.apply(this,arguments);}_createClass(Content,[{key:\"render\",value:function render(){var _this$props$data=this.props.data,isLoading=_this$props$data.isLoading,errorMsg=_this$props$data.errorMsg,zipProgress=_this$props$data.zipProgress;if(isLoading){return/*#__PURE__*/_jsx(Loading,{});}if(errorMsg){return/*#__PURE__*/_jsxs(\"div\",{className:\"text-center mt-7 mb-8\",children:[/*#__PURE__*/_jsx(\"img\",{src:\"\".concat(mediaUrl,\"img/error-tip.png\"),alt:\"\",width:\"100\"}),/*#__PURE__*/_jsx(\"p\",{className:\"mt-3\",children:errorMsg})]});}return/*#__PURE__*/_jsx(\"p\",{className:\"mt-4 text-center\",children:\"\".concat(gettext('Packaging...'),\" \").concat(zipProgress)});}}]);return Content;}(React.Component);export default ZipDownloadDialog;","map":{"version":3,"names":["React","Modal","ModalHeader","ModalBody","mediaUrl","gettext","fileServerRoot","seafileAPI","Utils","Loading","jsx","_jsx","jsxs","_jsxs","interval","ZipDownloadDialog","_React$Component","_inherits","_super","_createSuper","props","_this","_classCallCheck","call","queryZipProgress","zipToken","state","then","res","data","failed","clearInterval","errorMsg","failed_reason","setState","isLoading","zipProgress","total","zipped","toFixed","toggleDialog","location","href","concat","catch","error","getErrorMsg","cancelZipTask","_createClass","key","value","componentDidMount","_this2","_this$props","token","path","repoID","target","getZipTask","length","getShareLinkDirentsZipTask","getShareLinkZipTask","zipDownload","setInterval","render","isOpen","toggle","children","Content","Component","_React$Component2","_super2","apply","arguments","_this$props$data","className","src","alt","width"],"sources":["/Users/abel/Documents/Code-Experiments/cool-storage-api/frontend/src/components/dialog/zip-download-dialog.js"],"sourcesContent":["import React from 'react';\nimport PropTypes from 'prop-types';\nimport { Modal, ModalHeader, ModalBody } from 'reactstrap';\nimport { mediaUrl, gettext, fileServerRoot } from '../../utils/constants';\nimport { seafileAPI } from '../../utils/seafile-api';\nimport { Utils } from '../../utils/utils';\nimport Loading from '../loading';\n\nconst propTypes = {\n  data: PropTypes.object,\n  token: PropTypes.string,\n  path: PropTypes.string.isRequired,\n  repoID: PropTypes.string,\n  target: PropTypes.oneOfType([\n    PropTypes.string,\n    PropTypes.array\n  ]),\n  toggleDialog: PropTypes.func.isRequired\n};\n\nlet interval;\n\nclass ZipDownloadDialog extends React.Component {\n  constructor(props) {\n    super(props);\n    this.state = {\n      isLoading: true,\n      errorMsg: '',\n      zipProgress: null\n    };\n  }\n\n  componentDidMount() {\n    const { token, path, repoID, target } = this.props;\n    let getZipTask;\n    if (token) {\n      getZipTask = target.length ?\n        seafileAPI.getShareLinkDirentsZipTask(token, path, target) :\n        seafileAPI.getShareLinkZipTask(token, path);\n    } else {\n      getZipTask = seafileAPI.zipDownload(repoID, path, target);\n    }\n    getZipTask.then((res) => {\n      const zipToken = res.data['zip_token'];\n      this.setState({\n        isLoading: false,\n        errorMsg: '',\n        zipToken: zipToken\n      });\n      this.queryZipProgress();\n      interval = setInterval(this.queryZipProgress, 1000);\n    }).catch((error) => {\n      let errorMsg = Utils.getErrorMsg(error);\n      this.setState({\n        isLoading: false,\n        errorMsg: errorMsg\n      });\n    });\n  }\n\n  queryZipProgress = () => {\n    const zipToken = this.state.zipToken;\n    seafileAPI.queryZipProgress(zipToken).then((res) => {\n      const data = res.data;\n      if (data.failed == 1) {\n        clearInterval(interval);\n        let errorMsg;\n        switch (data.failed_reason) { // returned from seaserv\n          case 'size too large':\n            errorMsg = gettext('Failed to download. The total size of the files exceeded the limit.');\n            break;\n          case 'internal error':\n            errorMsg = gettext('Internal Server Error');\n            break;\n          default:\n            errorMsg = gettext('Error');\n        }\n        this.setState({\n          isLoading: false,\n          errorMsg: errorMsg\n        });\n      } else {\n        this.setState({\n          zipProgress: data.total == 0 ? '100%' : (data.zipped/data.total*100).toFixed(2) + '%'\n        });\n        if (data['total'] == data['zipped']) {\n          clearInterval(interval);\n          this.props.toggleDialog();\n          location.href = `${fileServerRoot}zip/${zipToken}`;\n        }\n      }\n    }).catch((error) => {\n      clearInterval(interval);\n      let errorMsg = Utils.getErrorMsg(error);\n      this.setState({\n        isLoading: false,\n        errorMsg: errorMsg\n      });\n    });\n  };\n\n  cancelZipTask = () => {\n    const zipToken = this.state.zipToken;\n    seafileAPI.cancelZipTask(zipToken).then((res) => {\n    // do nothing\n    }).catch((error) => {\n    // do nothing\n    });\n  };\n\n  toggleDialog = () => {\n    const zipProgress = this.state.zipProgress;\n    if (zipProgress && zipProgress != '100%') {\n      clearInterval(interval);\n      this.cancelZipTask();\n    }\n    this.props.toggleDialog();\n  };\n\n  render() {\n    return (\n      <Modal isOpen={true} toggle={this.toggleDialog}>\n        <ModalHeader toggle={this.toggleDialog}>{gettext('Download')}</ModalHeader>\n        <ModalBody>\n          <Content data={this.state} />\n        </ModalBody>\n      </Modal>\n    );\n  }\n}\n\nclass Content extends React.Component {\n\n  render() {\n    const {isLoading, errorMsg, zipProgress} = this.props.data;\n\n    if (isLoading) {\n      return <Loading />;\n    }\n\n    if (errorMsg) {\n      return (\n        <div className=\"text-center mt-7 mb-8\">\n          <img src={`${mediaUrl}img/error-tip.png`} alt=\"\" width=\"100\" />\n          <p className=\"mt-3\">{errorMsg}</p>\n        </div>\n      );\n    }\n\n    return <p className=\"mt-4 text-center\">{`${gettext('Packaging...')} ${zipProgress}`}</p>;\n  }\n}\n\nContent.propTypes = {\n  data: PropTypes.object,\n};\n\nZipDownloadDialog.propTypes = propTypes;\n\nexport default ZipDownloadDialog;\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}