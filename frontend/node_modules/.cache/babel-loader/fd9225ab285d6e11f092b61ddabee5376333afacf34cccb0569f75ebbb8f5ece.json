{"ast":null,"code":"import _toConsumableArray from \"/Users/abel/Documents/Code-Experiments/cool-storage-api/frontend/node_modules/@babel/runtime/helpers/esm/toConsumableArray.js\";\nimport _createClass from \"/Users/abel/Documents/Code-Experiments/cool-storage-api/frontend/node_modules/@babel/runtime/helpers/esm/createClass.js\";\nimport _classCallCheck from \"/Users/abel/Documents/Code-Experiments/cool-storage-api/frontend/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";\nimport _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\nvar _class;\nimport EventBus from '../utils/event-bus';\nimport { syncRemoteOperations, reExecRevertOperationList, revertOperationList, syncRemoteCursorLocation } from './helpers';\nimport SocketClient from './socket-client';\nimport { clientDebug, conflictDebug, serverDebug, stateDebug } from '../utils/debug';\nimport { deleteCursor } from '../cursor/helper';\nimport { EXTERNAL_EVENT } from '../../constants';\n\n//  idle --> sending --> conflict --> idle\n//       --> conflict --> idle\n//       --> disconnect --> conflict --> idle\n//                      --> idle\nvar STATE = {\n  IDLE: 'idle',\n  SENDING: 'sending',\n  CONFLICT: 'conflict',\n  DISCONNECT: 'disconnect',\n  NEED_RELOAD: 'need_reload'\n};\nvar SocketManager = /*#__PURE__*/_createClass(function SocketManager(editor, _document, config) {\n  var _this = this;\n  _classCallCheck(this, SocketManager);\n  _defineProperty(this, \"getDocumentVersion\", function () {\n    var version = _this.document.version;\n    return version;\n  });\n  _defineProperty(this, \"updateDocumentVersion\", function (document) {\n    _this.document['version'] = document.version;\n  });\n  _defineProperty(this, \"receivePublishDocument\", function () {\n    _this.eventBus.dispatch(EXTERNAL_EVENT.PUBLISH_DOCUMENT);\n  });\n  _defineProperty(this, \"receivePublishDocumentError\", function () {\n    _this.eventBus.dispatch(EXTERNAL_EVENT.PUBLISH_DOCUMENT_ERROR);\n  });\n  _defineProperty(this, \"receiveRemoveDocument\", function () {\n    _this.eventBus.dispatch(EXTERNAL_EVENT.REMOVE_DOCUMENT);\n  });\n  _defineProperty(this, \"receiveRemoveDocumentError\", function () {\n    _this.eventBus.dispatch(EXTERNAL_EVENT.REMOVE_DOCUMENT_ERROR);\n  });\n  _defineProperty(this, \"receiveDocumentReplaced\", function () {\n    _this.eventBus.dispatch(EXTERNAL_EVENT.DOCUMENT_REPLACED);\n  });\n  _defineProperty(this, \"receiveDocumentReplacedError\", function () {\n    _this.eventBus.dispatch(EXTERNAL_EVENT.DOCUMENT_REPLACED_ERROR);\n  });\n  _defineProperty(this, \"receiveNewNotification\", function (notification) {\n    _this.eventBus.dispatch(EXTERNAL_EVENT.NEW_NOTIFICATION, notification);\n  });\n  _defineProperty(this, \"onReceiveLocalOperations\", function (operations) {\n    if (_this.editor.readonly) return;\n    _this.pendingOperationList.push(operations);\n    var lastOpBeginTime = new Date().getTime();\n    _this.pendingOperationBeginTimeList.push(lastOpBeginTime);\n    var firstOpBeginTime = _this.pendingOperationBeginTimeList[0];\n    var isExceedExecuteTime = (lastOpBeginTime - firstOpBeginTime) / 1000 > 30 ? true : false;\n    if (isExceedExecuteTime || _this.pendingOperationList.length > 50) {\n      _this.dispatchConnectState('pending_operations_exceed_limit');\n    }\n    _this.sendOperations();\n  });\n  _defineProperty(this, \"sendOperations\", function () {\n    if (_this.editor.readonly) return;\n    if (_this.state !== STATE.IDLE) return;\n    stateDebug(\"State changed: \".concat(_this.state, \" -> \").concat(STATE.SENDING));\n    _this.state = STATE.SENDING;\n    _this.sendNextOperations();\n  });\n  _defineProperty(this, \"sendNextOperations\", function () {\n    if (_this.state !== STATE.SENDING) return;\n    if (_this.pendingOperationList.length === 0) {\n      stateDebug(\"State Changed: \".concat(_this.state, \" -> \").concat(STATE.IDLE));\n      _this.state = STATE.IDLE;\n      return;\n    }\n    _this.dispatchConnectState('is-saving');\n    var version = _this.document.version;\n    var operations = _this.pendingOperationList.shift();\n    var selection = _this.editor.selection;\n    _this._sendingOperations = operations;\n    _this.socketClient.sendOperations(operations, version, selection, _this.sendOperationsCallback);\n  });\n  _defineProperty(this, \"sendOperationsCallback\", function (result) {\n    if (result && result.success) {\n      var serverVersion = result.version;\n      _this.document['version'] = serverVersion;\n      var lastSavedAt = new Date().getTime();\n      _this.dispatchConnectState('saved', lastSavedAt);\n\n      // send next operations\n      _this.pendingOperationBeginTimeList.shift(); // remove current operation's begin time\n      _this._sendingOperations = null;\n      _this.sendNextOperations();\n      return;\n    }\n\n    // Operations are execute failure\n    var error_type = result.error_type;\n    if (error_type === 'load_document_content_error' || error_type === 'save_operations_to_database_error') {\n      // load_document_content_error: After a short-term reconnection, the content of the document fails to load\n      // save_operation_to_database_error: Save operation to database error\n      _this.dispatchConnectState(error_type);\n\n      // reset sending control\n      stateDebug(\"State Changed: \".concat(_this.state, \" -> \").concat(STATE.NEED_RELOAD));\n      _this.state = STATE.NEED_RELOAD;\n      _this._sendingOperations = null;\n    } else if (error_type === 'version_behind_server') {\n      // Put the failed operation into the pending list and re-execute it\n      _this.pendingOperationList.unshift(_toConsumableArray(_this._sendingOperations));\n      stateDebug(\"State Changed: \".concat(_this.state, \" -> \").concat(STATE.CONFLICT));\n      _this.state = STATE.CONFLICT;\n      var lose_operations = result.lose_operations;\n      _this.resolveConflicting(lose_operations);\n    } else if (error_type === 'execute_client_operations_error') {\n      _this.editor.isRemote = true;\n      var dupSendingOperations = _toConsumableArray(_this._sendingOperations);\n      revertOperationList(_this.editor, [dupSendingOperations]);\n\n      // Update the save time after revert\n      var _lastSavedAt = new Date().getTime();\n      _this.dispatchConnectState('saved', _lastSavedAt);\n\n      // Set isRemote to false must be in Promise.resolve function, make sure the modification of isRemote is later than the onChange event\n      Promise.resolve().then(function (_) {\n        _this.editor.isRemote = false;\n        _this.dispatchConnectState(error_type);\n\n        // send next operations\n        _this._sendingOperations = null;\n        _this.sendNextOperations();\n      });\n    }\n  });\n  _defineProperty(this, \"onReceiveRemoteOperations\", function (params) {\n    // if this.disconnect is true, Then the message sent by the remote end cannot be received\n    if (_this.state !== STATE.IDLE) return;\n    if (_this.editor.readonly) return;\n    var serverVersion = params.version;\n    var clientVersion = _this.document.version;\n    if (serverVersion === clientVersion + 1) {\n      // update execute remote operations flag\n      _this.editor.isRemote = true;\n      var operations = params.operations;\n      // Update content & version\n      serverDebug('execute remote operations: %O', operations);\n      try {\n        syncRemoteOperations(_this.editor, operations);\n      } catch (error) {\n        stateDebug(\"State Changed: \".concat(_this.state, \" -> \").concat(STATE.CONFLICT));\n        _this.state = STATE.CONFLICT;\n        _this.dispatchConnectState('sync_server_operations_error');\n        return;\n      }\n\n      // Update document\n      _this.document.version = serverVersion;\n      _this.document.children = _this.editor.children;\n      Promise.resolve().then(function () {\n        _this.editor.isRemote = false;\n        _this.revertOperationList = [];\n      });\n    } else {\n      // isConflict\n      _this.onConflictHappen();\n    }\n  });\n  _defineProperty(this, \"onReconnect\", function (result) {\n    var serverVersion = result.version;\n    var clientVersion = _this.getDocumentVersion();\n    // The client version is inconsistent with the server version, and the latest operations performed by the server need to be loaded\n    if (serverVersion !== clientVersion) {\n      _this.onConflictHappen();\n      return;\n    }\n\n    // The version consistency indicates that there is no conflict and no processing is required\n    stateDebug(\"State Changed: \".concat(_this.state, \" -> \").concat(STATE.IDLE));\n    _this.state = STATE.IDLE;\n    if (_this.pendingOperationList.length > 0) {\n      clientDebug('After reconnection, manually trigger the execution of ops.');\n      stateDebug(\"State Changed: \".concat(_this.state, \" -> \").concat(STATE.SENDING));\n      _this.state = STATE.SENDING;\n      _this.sendNextOperations();\n    }\n  });\n  _defineProperty(this, \"onConflictHappen\", function () {\n    stateDebug(\"State Changed: \".concat(_this.state, \" -> \").concat(STATE.CONFLICT));\n    _this.state = STATE.CONFLICT;\n    _this.socketClient.getRecentOperations();\n  });\n  _defineProperty(this, \"onGetRecentOperations\", function (result) {\n    if (_this.editor.readonly) return;\n    var mode = result.mode,\n      content = result.content;\n    conflictDebug('Start conflict resolution');\n    // sync document\n    if (mode === 'document') {\n      var version = content.version,\n        children = content.children;\n      // 1. update document\n      conflictDebug('Update local document to remote document');\n      _this.document.children = children;\n      _this.document.version = version;\n      _this.editor.children = children;\n      _this.editor.isRemote = true;\n      _this.editor.onChange();\n      stateDebug(\"State Changed: \".concat(_this.state, \" -> \").concat(STATE.IDLE));\n      _this.editor.isRemote = false;\n      _this.state = STATE.IDLE;\n      _this._sendingOperations = null;\n\n      // 2. exec client operationList\n      var pendingOperationList = _this.pendingOperationList.slice();\n      _this.pendingOperationList = [];\n\n      // need resend this operations to server\n      conflictDebug('Re-execute local unsynchronized operations: %o', pendingOperationList);\n      reExecRevertOperationList(_this.editor, pendingOperationList);\n      return;\n    }\n\n    // mode os operations: sync operations\n    // content is [{version, operations}, {version, operations}, ...]\n    var loseOperations = content;\n    _this.resolveConflicting(loseOperations);\n  });\n  _defineProperty(this, \"resolveConflicting\", function (loseOperations) {\n    if (_this.editor.readonly) return;\n    conflictDebug('resolve conflicts');\n    _this.editor.isRemote = true;\n    if (_this.pendingOperationList.length !== 0) {\n      // 1. Revert operations\n      // 1.1 record reverted operationList & clear pendingOperationList\n      _this.revertOperationList = _this.pendingOperationList.slice();\n      _this.pendingOperationList = [];\n\n      // 1.2 Revert operationList\n      conflictDebug('revert locale operations: %O', _this.revertOperationList);\n      revertOperationList(_this.editor, _this.revertOperationList);\n    }\n    loseOperations = loseOperations.sort(function (prev, next) {\n      return prev.version - next.version;\n    });\n    conflictDebug('lose operations length: %s', loseOperations.length);\n    while (loseOperations.length > 0) {\n      var operationParams = loseOperations.shift();\n      // 2. execute operations\n      var operations = operationParams.operations,\n        serverVersion = operationParams.version;\n      // 2.1 Update content & version\n      conflictDebug('execute lose operations: %O', operations);\n      try {\n        syncRemoteOperations(_this.editor, operations);\n      } catch (error) {\n        stateDebug(\"State Changed: \".concat(_this.state, \" -> \").concat(STATE.CONFLICT));\n        _this.state = STATE.CONFLICT;\n        _this.dispatchConnectState('sync_server_operations_error');\n        return;\n      }\n\n      // 2.2 Update document\n      _this.document.version = serverVersion;\n      _this.document.children = _this.editor.children;\n    }\n    if (_this.revertOperationList.length === 0) {\n      Promise.resolve().then(function () {\n        _this.editor.isRemote = false;\n        stateDebug(\"State Changed: \".concat(_this.state, \" -> \").concat(STATE.IDLE));\n        _this.state = STATE.IDLE;\n        _this._sendingOperations = null;\n        _this.revertOperationList = [];\n      });\n      return;\n    }\n\n    // Set isRemote to false must be in Promise.resolve function, make sure the modification of isRemote is later than the onChange event\n    Promise.resolve().then(function () {\n      // reset execute remote operations flag\n      _this.editor.isRemote = false;\n      stateDebug(\"State Changed: \".concat(_this.state, \" -> \").concat(STATE.IDLE));\n      _this.state = STATE.IDLE;\n      _this._sendingOperations = null;\n\n      // 3. Execute pending operations\n      // 3.1 Re-execute operations\n      conflictDebug('Editor isRemote is false: %s', _this.editor.isRemote);\n      conflictDebug('Re-execute pending operations, %O', _this.revertOperationList);\n      reExecRevertOperationList(_this.editor, _this.revertOperationList);\n\n      // 3.2 Clear revert operationList\n      _this.revertOperationList = [];\n      conflictDebug('Complete conflict resolution');\n    });\n  });\n  _defineProperty(this, \"sendCursorLocation\", function (location) {\n    _this.socketClient.sendCursorLocation(location);\n  });\n  _defineProperty(this, \"receiveCursorLocation\", function (params) {\n    if (_this.editor.readonly) return;\n    var user = params.user,\n      location = params.location,\n      cursorData = params.cursor_data;\n    syncRemoteCursorLocation(_this.editor, user, location, cursorData);\n    return;\n  });\n  _defineProperty(this, \"dispatchConnectState\", function (type, message) {\n    if (type === 'leave-room') {\n      deleteCursor(_this.editor, message);\n      _this.editor.onCursor && _this.editor.onCursor(_this.editor.cursors);\n    }\n    if (type === 'disconnect') {\n      // current state is sending\n      if (_this._sendingOperations) {\n        _this.pendingOperationList.unshift(_this._sendingOperations.slice());\n        _this._sendingOperations = null;\n      }\n      stateDebug(\"State Changed: \".concat(_this.state, \" -> \").concat(STATE.DISCONNECT));\n      _this.state = STATE.DISCONNECT;\n    }\n    _this.eventBus.dispatch(type, message);\n  });\n  _defineProperty(this, \"closeSocketConnect\", function () {\n    _this.socketClient.disconnectWithServer();\n  });\n  _defineProperty(this, \"receiveParticipantAdded\", function (uses) {\n    _this.eventBus.dispatch(EXTERNAL_EVENT.PARTICIPANT_ADDED, uses);\n  });\n  _defineProperty(this, \"receiveParticipantRemoved\", function (email) {\n    _this.eventBus.dispatch(EXTERNAL_EVENT.PARTICIPANT_REMOVED, email);\n  });\n  this.editor = editor;\n  this.document = _document;\n  this.socketClient = new SocketClient(config);\n  this.pendingOperationList = []; // Two-dimensional arrays： [operations, operations, ...]\n  this.pendingOperationBeginTimeList = [];\n  this.remoteOperationsList = []; // Same with pending operations\n  this.revertOperationList = [];\n  this.eventBus = EventBus.getInstance();\n  this.state = STATE.IDLE;\n});\n_class = SocketManager;\n_defineProperty(SocketManager, \"getInstance\", function (editor, document, socketConfig) {\n  if (_class.instance) {\n    return _class.instance;\n  }\n  if (!document || !socketConfig) {\n    throw new Error('SocketManager init params is invalid. Place check your code to fix it.');\n  }\n  _class.instance = new _class(editor, document, socketConfig);\n  return _class.instance;\n});\n_defineProperty(SocketManager, \"destroy\", function () {\n  _class.instance = null;\n});\nexport default SocketManager;","map":{"version":3,"names":["_defineProperty","_class","EventBus","syncRemoteOperations","reExecRevertOperationList","revertOperationList","syncRemoteCursorLocation","SocketClient","clientDebug","conflictDebug","serverDebug","stateDebug","deleteCursor","EXTERNAL_EVENT","STATE","IDLE","SENDING","CONFLICT","DISCONNECT","NEED_RELOAD","SocketManager","_createClass","editor","_document","config","_this","_classCallCheck","version","document","eventBus","dispatch","PUBLISH_DOCUMENT","PUBLISH_DOCUMENT_ERROR","REMOVE_DOCUMENT","REMOVE_DOCUMENT_ERROR","DOCUMENT_REPLACED","DOCUMENT_REPLACED_ERROR","notification","NEW_NOTIFICATION","operations","readonly","pendingOperationList","push","lastOpBeginTime","Date","getTime","pendingOperationBeginTimeList","firstOpBeginTime","isExceedExecuteTime","length","dispatchConnectState","sendOperations","state","concat","sendNextOperations","shift","selection","_sendingOperations","socketClient","sendOperationsCallback","result","success","serverVersion","lastSavedAt","error_type","unshift","_toConsumableArray","lose_operations","resolveConflicting","isRemote","dupSendingOperations","Promise","resolve","then","_","params","clientVersion","error","children","onConflictHappen","getDocumentVersion","getRecentOperations","mode","content","onChange","slice","loseOperations","sort","prev","next","operationParams","location","sendCursorLocation","user","cursorData","cursor_data","type","message","onCursor","cursors","disconnectWithServer","uses","PARTICIPANT_ADDED","email","PARTICIPANT_REMOVED","remoteOperationsList","getInstance","socketConfig","instance","Error"],"sources":["/Users/abel/Documents/Code-Experiments/cool-storage-api/frontend/node_modules/@seafile/sdoc-editor/dist/basic-sdk/socket/socket-manager.js"],"sourcesContent":["import _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\nvar _class;\nimport EventBus from '../utils/event-bus';\nimport { syncRemoteOperations, reExecRevertOperationList, revertOperationList, syncRemoteCursorLocation } from './helpers';\nimport SocketClient from './socket-client';\nimport { clientDebug, conflictDebug, serverDebug, stateDebug } from '../utils/debug';\nimport { deleteCursor } from '../cursor/helper';\nimport { EXTERNAL_EVENT } from '../../constants';\n\n//  idle --> sending --> conflict --> idle\n//       --> conflict --> idle\n//       --> disconnect --> conflict --> idle\n//                      --> idle\nconst STATE = {\n  IDLE: 'idle',\n  SENDING: 'sending',\n  CONFLICT: 'conflict',\n  DISCONNECT: 'disconnect',\n  NEED_RELOAD: 'need_reload'\n};\nclass SocketManager {\n  constructor(editor, _document, config) {\n    _defineProperty(this, \"getDocumentVersion\", () => {\n      const {\n        version\n      } = this.document;\n      return version;\n    });\n    _defineProperty(this, \"updateDocumentVersion\", document => {\n      this.document['version'] = document.version;\n    });\n    _defineProperty(this, \"receivePublishDocument\", () => {\n      this.eventBus.dispatch(EXTERNAL_EVENT.PUBLISH_DOCUMENT);\n    });\n    _defineProperty(this, \"receivePublishDocumentError\", () => {\n      this.eventBus.dispatch(EXTERNAL_EVENT.PUBLISH_DOCUMENT_ERROR);\n    });\n    _defineProperty(this, \"receiveRemoveDocument\", () => {\n      this.eventBus.dispatch(EXTERNAL_EVENT.REMOVE_DOCUMENT);\n    });\n    _defineProperty(this, \"receiveRemoveDocumentError\", () => {\n      this.eventBus.dispatch(EXTERNAL_EVENT.REMOVE_DOCUMENT_ERROR);\n    });\n    _defineProperty(this, \"receiveDocumentReplaced\", () => {\n      this.eventBus.dispatch(EXTERNAL_EVENT.DOCUMENT_REPLACED);\n    });\n    _defineProperty(this, \"receiveDocumentReplacedError\", () => {\n      this.eventBus.dispatch(EXTERNAL_EVENT.DOCUMENT_REPLACED_ERROR);\n    });\n    _defineProperty(this, \"receiveNewNotification\", notification => {\n      this.eventBus.dispatch(EXTERNAL_EVENT.NEW_NOTIFICATION, notification);\n    });\n    _defineProperty(this, \"onReceiveLocalOperations\", operations => {\n      if (this.editor.readonly) return;\n      this.pendingOperationList.push(operations);\n      const lastOpBeginTime = new Date().getTime();\n      this.pendingOperationBeginTimeList.push(lastOpBeginTime);\n      const firstOpBeginTime = this.pendingOperationBeginTimeList[0];\n      const isExceedExecuteTime = (lastOpBeginTime - firstOpBeginTime) / 1000 > 30 ? true : false;\n      if (isExceedExecuteTime || this.pendingOperationList.length > 50) {\n        this.dispatchConnectState('pending_operations_exceed_limit');\n      }\n      this.sendOperations();\n    });\n    _defineProperty(this, \"sendOperations\", () => {\n      if (this.editor.readonly) return;\n      if (this.state !== STATE.IDLE) return;\n      stateDebug(\"State changed: \".concat(this.state, \" -> \").concat(STATE.SENDING));\n      this.state = STATE.SENDING;\n      this.sendNextOperations();\n    });\n    _defineProperty(this, \"sendNextOperations\", () => {\n      if (this.state !== STATE.SENDING) return;\n      if (this.pendingOperationList.length === 0) {\n        stateDebug(\"State Changed: \".concat(this.state, \" -> \").concat(STATE.IDLE));\n        this.state = STATE.IDLE;\n        return;\n      }\n      this.dispatchConnectState('is-saving');\n      const version = this.document.version;\n      const operations = this.pendingOperationList.shift();\n      const selection = this.editor.selection;\n      this._sendingOperations = operations;\n      this.socketClient.sendOperations(operations, version, selection, this.sendOperationsCallback);\n    });\n    _defineProperty(this, \"sendOperationsCallback\", result => {\n      if (result && result.success) {\n        const {\n          version: serverVersion\n        } = result;\n        this.document['version'] = serverVersion;\n        const lastSavedAt = new Date().getTime();\n        this.dispatchConnectState('saved', lastSavedAt);\n\n        // send next operations\n        this.pendingOperationBeginTimeList.shift(); // remove current operation's begin time\n        this._sendingOperations = null;\n        this.sendNextOperations();\n        return;\n      }\n\n      // Operations are execute failure\n      const {\n        error_type\n      } = result;\n      if (error_type === 'load_document_content_error' || error_type === 'save_operations_to_database_error') {\n        // load_document_content_error: After a short-term reconnection, the content of the document fails to load\n        // save_operation_to_database_error: Save operation to database error\n        this.dispatchConnectState(error_type);\n\n        // reset sending control\n        stateDebug(\"State Changed: \".concat(this.state, \" -> \").concat(STATE.NEED_RELOAD));\n        this.state = STATE.NEED_RELOAD;\n        this._sendingOperations = null;\n      } else if (error_type === 'version_behind_server') {\n        // Put the failed operation into the pending list and re-execute it\n        this.pendingOperationList.unshift([...this._sendingOperations]);\n        stateDebug(\"State Changed: \".concat(this.state, \" -> \").concat(STATE.CONFLICT));\n        this.state = STATE.CONFLICT;\n        const {\n          lose_operations\n        } = result;\n        this.resolveConflicting(lose_operations);\n      } else if (error_type === 'execute_client_operations_error') {\n        this.editor.isRemote = true;\n        const dupSendingOperations = [...this._sendingOperations];\n        revertOperationList(this.editor, [dupSendingOperations]);\n\n        // Update the save time after revert\n        const lastSavedAt = new Date().getTime();\n        this.dispatchConnectState('saved', lastSavedAt);\n\n        // Set isRemote to false must be in Promise.resolve function, make sure the modification of isRemote is later than the onChange event\n        Promise.resolve().then(_ => {\n          this.editor.isRemote = false;\n          this.dispatchConnectState(error_type);\n\n          // send next operations\n          this._sendingOperations = null;\n          this.sendNextOperations();\n        });\n      }\n    });\n    _defineProperty(this, \"onReceiveRemoteOperations\", params => {\n      // if this.disconnect is true, Then the message sent by the remote end cannot be received\n      if (this.state !== STATE.IDLE) return;\n      if (this.editor.readonly) return;\n      const {\n        version: serverVersion\n      } = params;\n      const {\n        version: clientVersion\n      } = this.document;\n      if (serverVersion === clientVersion + 1) {\n        // update execute remote operations flag\n        this.editor.isRemote = true;\n        const {\n          operations\n        } = params;\n        // Update content & version\n        serverDebug('execute remote operations: %O', operations);\n        try {\n          syncRemoteOperations(this.editor, operations);\n        } catch (error) {\n          stateDebug(\"State Changed: \".concat(this.state, \" -> \").concat(STATE.CONFLICT));\n          this.state = STATE.CONFLICT;\n          this.dispatchConnectState('sync_server_operations_error');\n          return;\n        }\n\n        // Update document\n        this.document.version = serverVersion;\n        this.document.children = this.editor.children;\n        Promise.resolve().then(() => {\n          this.editor.isRemote = false;\n          this.revertOperationList = [];\n        });\n      } else {\n        // isConflict\n        this.onConflictHappen();\n      }\n    });\n    _defineProperty(this, \"onReconnect\", result => {\n      const {\n        version: serverVersion\n      } = result;\n      const clientVersion = this.getDocumentVersion();\n      // The client version is inconsistent with the server version, and the latest operations performed by the server need to be loaded\n      if (serverVersion !== clientVersion) {\n        this.onConflictHappen();\n        return;\n      }\n\n      // The version consistency indicates that there is no conflict and no processing is required\n      stateDebug(\"State Changed: \".concat(this.state, \" -> \").concat(STATE.IDLE));\n      this.state = STATE.IDLE;\n      if (this.pendingOperationList.length > 0) {\n        clientDebug('After reconnection, manually trigger the execution of ops.');\n        stateDebug(\"State Changed: \".concat(this.state, \" -> \").concat(STATE.SENDING));\n        this.state = STATE.SENDING;\n        this.sendNextOperations();\n      }\n    });\n    _defineProperty(this, \"onConflictHappen\", () => {\n      stateDebug(\"State Changed: \".concat(this.state, \" -> \").concat(STATE.CONFLICT));\n      this.state = STATE.CONFLICT;\n      this.socketClient.getRecentOperations();\n    });\n    _defineProperty(this, \"onGetRecentOperations\", result => {\n      if (this.editor.readonly) return;\n      const {\n        mode,\n        content\n      } = result;\n      conflictDebug('Start conflict resolution');\n      // sync document\n      if (mode === 'document') {\n        const {\n          version,\n          children\n        } = content;\n        // 1. update document\n        conflictDebug('Update local document to remote document');\n        this.document.children = children;\n        this.document.version = version;\n        this.editor.children = children;\n        this.editor.isRemote = true;\n        this.editor.onChange();\n        stateDebug(\"State Changed: \".concat(this.state, \" -> \").concat(STATE.IDLE));\n        this.editor.isRemote = false;\n        this.state = STATE.IDLE;\n        this._sendingOperations = null;\n\n        // 2. exec client operationList\n        const pendingOperationList = this.pendingOperationList.slice();\n        this.pendingOperationList = [];\n\n        // need resend this operations to server\n        conflictDebug('Re-execute local unsynchronized operations: %o', pendingOperationList);\n        reExecRevertOperationList(this.editor, pendingOperationList);\n        return;\n      }\n\n      // mode os operations: sync operations\n      // content is [{version, operations}, {version, operations}, ...]\n      const loseOperations = content;\n      this.resolveConflicting(loseOperations);\n    });\n    _defineProperty(this, \"resolveConflicting\", loseOperations => {\n      if (this.editor.readonly) return;\n      conflictDebug('resolve conflicts');\n      this.editor.isRemote = true;\n      if (this.pendingOperationList.length !== 0) {\n        // 1. Revert operations\n        // 1.1 record reverted operationList & clear pendingOperationList\n        this.revertOperationList = this.pendingOperationList.slice();\n        this.pendingOperationList = [];\n\n        // 1.2 Revert operationList\n        conflictDebug('revert locale operations: %O', this.revertOperationList);\n        revertOperationList(this.editor, this.revertOperationList);\n      }\n      loseOperations = loseOperations.sort((prev, next) => prev.version - next.version);\n      conflictDebug('lose operations length: %s', loseOperations.length);\n      while (loseOperations.length > 0) {\n        const operationParams = loseOperations.shift();\n        // 2. execute operations\n        const {\n          operations,\n          version: serverVersion\n        } = operationParams;\n        // 2.1 Update content & version\n        conflictDebug('execute lose operations: %O', operations);\n        try {\n          syncRemoteOperations(this.editor, operations);\n        } catch (error) {\n          stateDebug(\"State Changed: \".concat(this.state, \" -> \").concat(STATE.CONFLICT));\n          this.state = STATE.CONFLICT;\n          this.dispatchConnectState('sync_server_operations_error');\n          return;\n        }\n\n        // 2.2 Update document\n        this.document.version = serverVersion;\n        this.document.children = this.editor.children;\n      }\n      if (this.revertOperationList.length === 0) {\n        Promise.resolve().then(() => {\n          this.editor.isRemote = false;\n          stateDebug(\"State Changed: \".concat(this.state, \" -> \").concat(STATE.IDLE));\n          this.state = STATE.IDLE;\n          this._sendingOperations = null;\n          this.revertOperationList = [];\n        });\n        return;\n      }\n\n      // Set isRemote to false must be in Promise.resolve function, make sure the modification of isRemote is later than the onChange event\n      Promise.resolve().then(() => {\n        // reset execute remote operations flag\n        this.editor.isRemote = false;\n        stateDebug(\"State Changed: \".concat(this.state, \" -> \").concat(STATE.IDLE));\n        this.state = STATE.IDLE;\n        this._sendingOperations = null;\n\n        // 3. Execute pending operations\n        // 3.1 Re-execute operations\n        conflictDebug('Editor isRemote is false: %s', this.editor.isRemote);\n        conflictDebug('Re-execute pending operations, %O', this.revertOperationList);\n        reExecRevertOperationList(this.editor, this.revertOperationList);\n\n        // 3.2 Clear revert operationList\n        this.revertOperationList = [];\n        conflictDebug('Complete conflict resolution');\n      });\n    });\n    _defineProperty(this, \"sendCursorLocation\", location => {\n      this.socketClient.sendCursorLocation(location);\n    });\n    _defineProperty(this, \"receiveCursorLocation\", params => {\n      if (this.editor.readonly) return;\n      const {\n        user,\n        location,\n        cursor_data: cursorData\n      } = params;\n      syncRemoteCursorLocation(this.editor, user, location, cursorData);\n      return;\n    });\n    _defineProperty(this, \"dispatchConnectState\", (type, message) => {\n      if (type === 'leave-room') {\n        deleteCursor(this.editor, message);\n        this.editor.onCursor && this.editor.onCursor(this.editor.cursors);\n      }\n      if (type === 'disconnect') {\n        // current state is sending\n        if (this._sendingOperations) {\n          this.pendingOperationList.unshift(this._sendingOperations.slice());\n          this._sendingOperations = null;\n        }\n        stateDebug(\"State Changed: \".concat(this.state, \" -> \").concat(STATE.DISCONNECT));\n        this.state = STATE.DISCONNECT;\n      }\n      this.eventBus.dispatch(type, message);\n    });\n    _defineProperty(this, \"closeSocketConnect\", () => {\n      this.socketClient.disconnectWithServer();\n    });\n    _defineProperty(this, \"receiveParticipantAdded\", uses => {\n      this.eventBus.dispatch(EXTERNAL_EVENT.PARTICIPANT_ADDED, uses);\n    });\n    _defineProperty(this, \"receiveParticipantRemoved\", email => {\n      this.eventBus.dispatch(EXTERNAL_EVENT.PARTICIPANT_REMOVED, email);\n    });\n    this.editor = editor;\n    this.document = _document;\n    this.socketClient = new SocketClient(config);\n    this.pendingOperationList = []; // Two-dimensional arrays： [operations, operations, ...]\n    this.pendingOperationBeginTimeList = [];\n    this.remoteOperationsList = []; // Same with pending operations\n    this.revertOperationList = [];\n    this.eventBus = EventBus.getInstance();\n    this.state = STATE.IDLE;\n  }\n}\n_class = SocketManager;\n_defineProperty(SocketManager, \"getInstance\", (editor, document, socketConfig) => {\n  if (_class.instance) {\n    return _class.instance;\n  }\n  if (!document || !socketConfig) {\n    throw new Error('SocketManager init params is invalid. Place check your code to fix it.');\n  }\n  _class.instance = new _class(editor, document, socketConfig);\n  return _class.instance;\n});\n_defineProperty(SocketManager, \"destroy\", () => {\n  _class.instance = null;\n});\nexport default SocketManager;"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}